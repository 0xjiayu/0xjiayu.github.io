<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="qBZOdQGNufiwjuoePxh48OOtXbE2OcD2yxZE6tLxrsM" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="http://apps.bdimg.com/libs/webfont/1.3.0/webfont_debug.js/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="security,c++,re," />





  <link rel="alternate" href="/atom.xml" title="JiaYu's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="原文： http://www.openrce.org/articles/full_view/21  

摘要MSVC++ 是编写 Win32 应用程序最常用的编译器，所以在 Win32 平台的逆向工作中，懂得其底层工作原理，对逆向工程师来说至关重要。掌握 VC++ 程序的底层原理之后，便能在逆向过程中精准、快速识别编译器生成的胶水代码（Glue Code），这样可以让逆向工程师快速聚焦于二进制文">
<meta property="og:type" content="article">
<meta property="og:title" content="(译)MSVC++ 逆向(一) —— 异常处理">
<meta property="og:url" content="http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/index.html">
<meta property="og:site_name" content="JiaYu's Blog">
<meta property="og:description" content="原文： http://www.openrce.org/articles/full_view/21  

摘要MSVC++ 是编写 Win32 应用程序最常用的编译器，所以在 Win32 平台的逆向工作中，懂得其底层工作原理，对逆向工程师来说至关重要。掌握 VC++ 程序的底层原理之后，便能在逆向过程中精准、快速识别编译器生成的胶水代码（Glue Code），这样可以让逆向工程师快速聚焦于二进制文">
<meta property="og:image" content="http://jiayu0x.com/imgs/14931296110235.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14931296634632.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14931297820310.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14931309060247.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14932976893461.gif">
<meta property="og:updated_time" content="2017-05-03T15:35:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(译)MSVC++ 逆向(一) —— 异常处理">
<meta name="twitter:description" content="原文： http://www.openrce.org/articles/full_view/21  

摘要MSVC++ 是编写 Win32 应用程序最常用的编译器，所以在 Win32 平台的逆向工作中，懂得其底层工作原理，对逆向工程师来说至关重要。掌握 VC++ 程序的底层原理之后，便能在逆向过程中精准、快速识别编译器生成的胶水代码（Glue Code），这样可以让逆向工程师快速聚焦于二进制文">
<meta name="twitter:image" content="http://jiayu0x.com/imgs/14931296110235.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","d#isplay":"post","display":"hide","offset":12,"offset_float":0,"b2t":true,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/"/>





  <title> (译)MSVC++ 逆向(一) —— 异常处理 | JiaYu's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-96776353-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?48422440cafd0d34da02c8973715c008";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JiaYu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">浪人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0xjiayu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JiaYu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                (译)MSVC++ 逆向(一) —— 异常处理
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-25T00:00:00+08:00">
                2017-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index">
                    <span itemprop="name">security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/25/reversing-msvcxx-exception-handling/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/25/reversing-msvcxx-exception-handling/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>原文： <a href="http://www.openrce.org/articles/full_view/21" target="_blank" rel="external">http://www.openrce.org/articles/full_view/21</a>  </p>
</blockquote>
<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p><strong>MSVC++</strong> 是编写 Win32 应用程序最常用的编译器，所以在 Win32 平台的逆向工作中，懂得其底层工作原理，对逆向工程师来说至关重要。掌握 VC++ 程序的底层原理之后，便能在逆向过程中精准、快速识别编译器生成的<strong>胶水代码</strong>（Glue Code），这样可以让逆向工程师快速聚焦于二进制文件背后的真实程序和真实逻辑。另外，这对还原程序中高层次的结构（<strong><code>译注</code></strong>：面向对象的数据结构和程序组织结构、异常相关数据结构等）也有莫大帮助。  </p>
<p>本文只是系列文章的上半部分（下半部分见： <a href="http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/">(译)MSVC++ 逆向（二）—— 类、方法和 RTTI</a>），主要讲栈展开、异常处理以及 MSVC 编译生成相关的数据结构。阅读本文需要有汇编、寄存器和调用约定相关的知识储备，当然，MSVC++ 的编程基础知识也是必要的。  </p>
<a id="more"></a>
<p><strong>名词解释</strong>：</p>
<blockquote>
<ul>
<li><strong>栈帧（Stack Frame）</strong>：<strong>栈</strong> 中为<strong>函数</strong>所用的一个 <strong>片段</strong>，里面通常包含函数相关的<strong>参数</strong>（Arguments）、<strong>返回地址</strong>（Return-to-Caller Address）、<strong>保存的寄存器状态</strong>、<strong>本地变量</strong>（Local Variables）和一些其他的数据。在 <strong>x86</strong> 架构（以及其他多数架构）中，栈里调用和被调用的函数，栈帧通常是连续的；</li>
<li><strong>帧指针（Frame Pointer）</strong>：一个指向栈中特定<strong>位置</strong>的指针，指针值通常保存在寄存器或某个变量中。访问函数中的数据，一般通过帧指针和特定<strong>偏移量</strong>来实现。在 <strong>x86</strong> 架构里，<strong>帧指针</strong>通常保存在寄存器 <strong><code>ebp</code></strong>中，并且，在栈布局结构中位于<strong>返回地址</strong>的下方；</li>
<li><strong>对象（Object）</strong>：C++ 类的实例；</li>
<li><strong>可销毁对象（Unwindable Object）</strong>：又叫<strong>局部对象</strong>，一个具有 <code>auto</code> 作用域的本地对象，当帧指针访问其作用域之外的位置时该对象会被销毁（<strong><code>译注</code></strong>：函数内部本地变量的默认作用域就是 <code>auto</code>，函数被调用的时候其内部变量及其他数据被生成到栈上，调用完毕就会销毁这段栈的片段，其内部变量也就随之被销毁）；</li>
<li><strong>栈展开（Stack Unwinding）</strong>：触发异常的时候，将暂停当前函数的执行，根据 <code>C++</code> 的 <code>try/throw/catch</code> 异常处理流程或 <code>SEH</code> 异常处理机制，会在栈段中线性搜索对应的异常处理函数，如果当前栈帧中没有相应的异常处理模块，就会退出当前函数，释放当前函数的内存并销毁局部对象，继续到上层调用函数中寻找对应的异常处理模块，直到找到可以处理该异常的模块……这个过程就是<strong>栈展开</strong>。</li>
</ul>
</blockquote>
<p>在 C/C++ 程序中，可用的异常处理机制有两种：</p>
<blockquote>
<ul>
<li><strong>SEH 异常</strong>：即<strong>结构化异常处理</strong>(Structured Exception Handling)，也称作 <strong>Win32 异常</strong> 或 <strong>系统异常</strong>，这部分内容在 <strong>Matt Pietrek</strong> 的 Paper[1] 里有详尽的讲解。该机制是 C 程序仅有的异常处理机制，在编译器层面支持的关键字有 <code>__try</code>/<code>__except</code>/<code>finally</code> 等等；</li>
<li><strong>C++ 异常</strong>：实现于 SEH 链的顶层，并且支持任意类型的 <code>throw</code> 和 <code>catch</code>。该异常处理机制一个非常重要的特性是在异常处理过程中的自动栈展开，MSVC++ 为了支持这一特性，在底层做了非常复杂的处理。</li>
</ul>
<p><strong><code>译注</code></strong>：<br>根据 <a href="https://msdn.microsoft.com/zh-cn/library/x057540h.aspx" target="_blank" rel="external">VC++ 中的异常处理 | MSDN</a> 所述，自 <code>MFC3.0</code> 起，MFC 程序中可以使用 MFC 特有的异常处理机制——<strong>MFC 异常</strong>。</p>
</blockquote>
<p>内存中，栈是由高地址向低地址方向增长的，所以在 IDA 中看到的栈，是<strong>向上增长</strong>的。</p>
<h2 id="栈的内存布局"><a href="#栈的内存布局" class="headerlink" title="栈的内存布局"></a>栈的内存布局</h2><p>基础的栈布局如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">---------------</div><div class="line">局部变量</div><div class="line">---------------</div><div class="line">其它寄存器的值</div><div class="line">---------------</div><div class="line">原栈基址 %ebp</div><div class="line">---------------</div><div class="line">返回地址</div><div class="line">---------------</div><div class="line">函数参数</div><div class="line">---------------</div><div class="line">……</div></pre></td></tr></table></figure>
<p>具体点，如下图所示：<br><img src="/imgs/14931296110235.jpg" alt="基础栈内存布局"></p>
<blockquote>
<p><strong>NOTE</strong>:<br>如果设置了 <strong><code>FPO</code></strong>（Frame Pointer Omission， 框架指针省略），<code>原栈基址 %ebp</code> 可能就不存在了。</p>
</blockquote>
<h2 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h2><p>当涉及到编译器层面的 <strong>SEH</strong>（<code>__try/__except/__finally</code>） 时，栈的内存布局就会变的复杂一些：<br><img src="/imgs/14931296634632.jpg" alt="SEH3 站内存布局"></p>
<p>一个函数中如果没有 <code>__try</code> 语句块（只有 <code>__finally</code>），<code>Saved ESP</code> 就不会存在。另外，<strong>作用域描述表</strong>（ <code>scopetable</code> ）是一个记录每一个 <code>try</code> 块及其关系描述的数组：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _SCOPETABLE_ENTRY &#123;</div><div class="line">    DWORD EnclosingLevel;</div><div class="line">    <span class="keyword">void</span>* FilterFunc;</div><div class="line">    <span class="keyword">void</span>* HandlerFunc;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更多 SEH 具体的实现细节可以查阅参考资料[1]。为了恢复 <code>try</code> 语句块，需要监控 <code>try</code> 层面的变量变化。 SEH 为每一个 <code>try</code> 语句块分配了一个编号，语句块之间的相互联系用上面的 <code>scopetable</code> 结构体来描述。举个栗子，假设编号为 <code>i</code> 的 <code>scopetable</code> ，其中属性 <code>EnclosingLevel</code> 值为 <code>j</code>，那么编号为  <code>j</code> 的 <code>try</code> 语句块会把 <code>i</code> 闭合在自己的作用域内。然后该函数的 <code>try level</code> 可以认为是 <code>-1</code> 。具体例子可以参考<strong>附录1</strong>。</p>
<h2 id="栈越界（溢出）保护"><a href="#栈越界（溢出）保护" class="headerlink" title="栈越界（溢出）保护"></a>栈越界（溢出）保护</h2><p><code>Whidbey</code> 编译器（即 <strong>MSVC-2005</strong>）为栈中的 SEH 帧添加了缓冲区溢出保护机制，如此一来，栈内存布局就变成了下图这样：<br><img src="/imgs/14931297820310.jpg" alt="SEH4 栈内存布局"></p>
<p><code>EH Cookie</code> 会一直存在，而 <code>GS cookie</code> 段只有在编译时开启了 <code>/GS</code> 选项才会出现。<code>SEH4</code> 的作用域描述表（ <code>scopetable</code> ）跟 <code>SEH3</code> 的差不多，不同的是多了以下两组头部字段：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _EH4_SCOPETABLE &#123;</div><div class="line">    DWORD GSCookieOffset;</div><div class="line">    DWORD GSCookieXOROffset;</div><div class="line">    DWORD EHCookieOffset;</div><div class="line">    DWORD EHCookieXOROffset;</div><div class="line">    _EH4_SCOPETABLE_RECORD ScopeRecord[<span class="number">1</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> _EH4_SCOPETABLE_RECORD &#123;</div><div class="line">    DWORD EnclosingLevel;</div><div class="line">    <span class="keyword">long</span> (*FilterFunc)();</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">void</span> (*HandlerAddress)();</div><div class="line">        <span class="keyword">void</span> (*FinallyFunc)();</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>GSCookieOffset = -2</code> 表示没有启用 <code>GS cookie</code> ，<code>EH cookie</code> 会一直启用，并且访问时用到的偏移都是相对于 <code>%ebp</code> 来计算的。对 <code>security_cookie</code> 的校验方式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(ebp+CookieXOROffset) ^ [ebp+CookieOffset] == _security_cookie</div></pre></td></tr></table></figure>
<p>栈中指向 <code>scopetable</code> 的指针也要与 <code>_security_cookie</code> 进行异或计算。另外，<code>SEH4</code> 中最外层的作用域层级（<code>scope level</code>）是 <code>-2</code> ，而不是像 <code>SEH3</code> 中那样的 <code>-1</code>。</p>
<h2 id="C-异常模型实现"><a href="#C-异常模型实现" class="headerlink" title="C++ 异常模型实现"></a>C++ 异常模型实现</h2><p>如果函数中实现了 C++ 的异常处理，或者可销毁的<strong>局部对象</strong>，栈的内存布局就会变得更加复杂起来：<br><img src="/imgs/14931309060247.jpg" alt="C++ 异常n内存布局"></p>
<p>不同于 SEH，C++ 每一个函数中的异常处理内存布局都不相同，通常是如下形式：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// (VC7+)</div><div class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, OFFSET __ehfuncinfo</div><div class="line"><span class="keyword">jmp</span> ___CxxFrameHandler</div></pre></td></tr></table></figure>
<p>其中，<code>__ehfuncinfo</code> 是一个 <code>FuncInfo</code> 结构对象，该结构中囊括了函数中所有的 <code>try/catch</code> 块的描述以及可销毁对象信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> FuncInfo &#123;</div><div class="line">    <span class="comment">// 编译器版本</span></div><div class="line">    <span class="comment">// 0x19930520: 低于 VC6； 0x19930521: VC7.x(2002-2003)；0x19930522: VC8 (2005)</span></div><div class="line">    DWORD magicNumber;</div><div class="line"></div><div class="line">    <span class="comment">// 栈展开描述表中的入口数量</span></div><div class="line">    <span class="comment">// number of entries in unwind table</span></div><div class="line">    <span class="keyword">int</span> maxState;</div><div class="line"></div><div class="line">    <span class="comment">// 栈展开处理方法绑定表</span></div><div class="line">    <span class="comment">// table of unwind destructors</span></div><div class="line">    UnwindMapEntry* pUnwindMap;</div><div class="line"></div><div class="line">    <span class="comment">// 函数中的 try 语句块数量</span></div><div class="line">    DWORD nTryBlocks;</div><div class="line"></div><div class="line">    <span class="comment">// try-catch 映射表</span></div><div class="line">    <span class="comment">// mapping of catch blocks to try blocks</span></div><div class="line">    TryBlockMapEntry* pTryBlockMap;</div><div class="line"></div><div class="line">    <span class="comment">// x86 架构上不可用</span></div><div class="line">    <span class="comment">// not used on x86</span></div><div class="line">    DWORD nIPMapEntries;</div><div class="line"></div><div class="line">    <span class="comment">// not used on x86</span></div><div class="line">    <span class="keyword">void</span>* pIPtoStateMap;</div><div class="line"></div><div class="line">    <span class="comment">// VC7 及以上版本可用，期望异常列表</span></div><div class="line">    <span class="comment">// VC7+ only, expected exceptions list (function "throw" specifier)</span></div><div class="line">    ESTypeList* pESTypeList;</div><div class="line"></div><div class="line">    <span class="comment">// VC8 及以上版本可用，但以 /EHs 选项编译时会置 零</span></div><div class="line">    <span class="comment">// VC8+ only, bit 0 set if function was compiled with /EHs</span></div><div class="line">    <span class="keyword">int</span> EHFlags;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>栈展开映射（<code>Unwind map</code>）类似 SEH 作用域描述表（<code>SEH scopetable</code>），只是少了过滤函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> UnwindMapEntry &#123;</div><div class="line">    <span class="keyword">int</span> toState;        <span class="comment">// target state</span></div><div class="line">    <span class="keyword">void</span> (*action)();   <span class="comment">// 栈展开时调用的处理函数</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>try</code> 语句块描述结构体，描述一个 <code>try{}</code> 块对应的 <code>catch{}</code> 块的映射信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> TryBlockMapEntry &#123;</div><div class="line">    <span class="keyword">int</span> tryLow;</div><div class="line">    <span class="keyword">int</span> tryHigh;    <span class="comment">// this try &#123;&#125; covers states ranging from tryLow to tryHigh</span></div><div class="line">    <span class="keyword">int</span> catchHigh;  <span class="comment">// highest state inside catch handlers of this try</span></div><div class="line">    <span class="keyword">int</span> nCatches;   <span class="comment">// number of catch handlers</span></div><div class="line">    HandlerType* pHandlerArray; <span class="comment">//catch handlers table</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>catch</code> 语句块描述表，描述对应某个 <code>catch{}</code> 块的单个 <code>try{}</code> 块的相关信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> HandlerType &#123;</div><div class="line">    <span class="comment">// 0x01: const, 0x02: volatile, 0x08: reference</span></div><div class="line">    DWORD adjectives;</div><div class="line"></div><div class="line">    <span class="comment">// RTTI descriptor of the exception type. 0=any (ellipsis)</span></div><div class="line">    TypeDescriptor* pType;</div><div class="line"></div><div class="line">    <span class="comment">// ebp-based offset of the exception object in the function stack.</span></div><div class="line">    <span class="comment">// 0 = no object (catch by type)</span></div><div class="line">    <span class="keyword">int</span> dispCatchObj;</div><div class="line"></div><div class="line">    <span class="comment">// address of the catch handler code.</span></div><div class="line">    <span class="comment">// returns address where to continues execution (i.e. code after the try block)</span></div><div class="line">    <span class="keyword">void</span>* addressOfHandler;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>期望异常列表（MSVC 中默认关闭，需要用 <code>/d1ESrt</code> 编译选项开启）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> ESTypeList &#123;</div><div class="line">    <span class="comment">// number of entries in the list</span></div><div class="line">    <span class="keyword">int</span> nCount;</div><div class="line"></div><div class="line">    <span class="comment">// list of exceptions; it seems only pType field in HandlerType is used</span></div><div class="line">    HandlerType* pTypeArray;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>RTTI</code>（<strong>Run-Time Type Information</strong>，运行时类型识别）类型描述表，描述 C++ 中的类型信息，这里会用 <code>catch</code> 块中的类型去匹配 <code>throw</code> 出来的异常的类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> TypeDescriptor &#123;</div><div class="line">    <span class="comment">// vtable of type_info class</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">void</span> * pVFTable;</div><div class="line"></div><div class="line">    <span class="comment">// used to keep the demangled name returned by type_info::name()</span></div><div class="line">    <span class="keyword">void</span>* spare;</div><div class="line"></div><div class="line">    <span class="comment">// mangled type name, e.g. ".H" = "int", ".?AUA@@" = "struct A", ".?AVA@@" = "class A"</span></div><div class="line">    <span class="keyword">char</span> name[<span class="number">0</span>];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>前面说过，不同于 SEH，C++ 每一个函数中的异常处理内存布局都不相同。编译器不仅会在 进/出 <code>try</code> 语句块的时候改变状态值，在创建/销毁一个对象的时候状态值也会做出相应改变。这样一来，异常被触发的时候就可以知道哪一个对象应该被栈展开而销毁。并且，我们还可以通过检查相关状态变化和 <code>try</code> 语句块处理句柄的返回地址来最终恢复 <code>try</code> 语句块的边界（详见 <strong>附录2</strong>）。</p>
<h2 id="抛出-C-异常"><a href="#抛出-C-异常" class="headerlink" title="抛出 C++ 异常"></a>抛出 C++ 异常</h2><p>C++ 中的 <code>throw</code> 表达式在底层会转换为对 <code>_CxxThrowException()</code> 的调用，这个调用会以特征码 <code>0xE06D7363</code>（<code>&#39;msc&#39;|0xE0000000</code>) 抛出一个 Win32 异常（即 SEH 异常）。SEH 异常的自定义参数里有异常对象及其对应的 <code>ThrowInfo</code> 结构体对象，其中 <code>ThrowInfo</code> 结构描述了被抛出来的异常的类型，异常处理句柄可以拿此类型与 <code>catch</code> 块中的期望异常类型做匹配检索。下面是 <code>ThrowInfo</code> 的结构定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> ThrowInfo &#123;</div><div class="line">    <span class="comment">// 0x01: const, 0x02: volatile</span></div><div class="line">    DWORD attributes;</div><div class="line"></div><div class="line">    <span class="comment">// exception destructor</span></div><div class="line">    <span class="keyword">void</span> (*pmfnUnwind)();</div><div class="line"></div><div class="line">    <span class="comment">// forward compatibility handler</span></div><div class="line">    <span class="keyword">int</span> (*pForwardCompat)();</div><div class="line"></div><div class="line">    <span class="comment">// list of types that can catch this exception.</span></div><div class="line">    <span class="comment">// i.e. the actual type and all its ancestors.</span></div><div class="line">    CatchableTypeArray* pCatchableTypeArray;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> CatchableTypeArray &#123;</div><div class="line">    <span class="comment">// number of entries in the following array</span></div><div class="line">    <span class="keyword">int</span> nCatchableTypes;</div><div class="line">    CatchableType* arrayOfCatchableTypes[<span class="number">0</span>];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中，<code>CatchableType</code> 定义了可以 <code>catch</code> 这种异常的类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> CatchableType &#123;</div><div class="line">    <span class="comment">// 0x01: simple type (can be copied by memmove), 0x02: can be caught by reference only, 0x04: has virtual bases</span></div><div class="line">    DWORD properties;</div><div class="line"></div><div class="line">    <span class="comment">// see above</span></div><div class="line">    TypeDescriptor* pType;</div><div class="line"></div><div class="line">    <span class="comment">// how to cast the thrown object to this type</span></div><div class="line">    PMD thisDisplacement;</div><div class="line"></div><div class="line">    <span class="comment">// object size</span></div><div class="line">    <span class="keyword">int</span> sizeOrOffset;</div><div class="line"></div><div class="line">    <span class="comment">// copy constructor address</span></div><div class="line">    <span class="keyword">void</span> (*copyFunction)();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Pointer-to-member descriptor.</span></div><div class="line"><span class="keyword">struct</span> PMD &#123;</div><div class="line">    <span class="comment">// member offset</span></div><div class="line">    <span class="keyword">int</span> mdisp;</div><div class="line"></div><div class="line">    <span class="comment">// offset of the vbtable (-1 if not a virtual base)</span></div><div class="line">    <span class="keyword">int</span> pdisp;</div><div class="line"></div><div class="line">    <span class="comment">// offset to the displacement value inside the vbtable</span></div><div class="line">    <span class="keyword">int</span> vdisp;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们会在下一篇深入阐述这一方面的内容。</p>
<h2 id="序言-与-结语（Prologs-amp-Epilogs）"><a href="#序言-与-结语（Prologs-amp-Epilogs）" class="headerlink" title="序言 与 结语（Prologs &amp; Epilogs）"></a><strong>序言</strong> 与 <strong>结语</strong>（Prologs &amp; Epilogs）</h2><p>为了避免向函数体部分注入设置栈帧的代码，编译器通常会选择用一些<strong>序言</strong>（<strong>Prologs</strong>）和<strong>结语</strong>（<strong>epilog</strong>）函数做一些处理。不过形式多种多样，不同类型的序言或结语作用于不同的函数类型：</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>EH Cookie</th>
<th>GS Cookie</th>
<th>Catch Handlers</th>
</tr>
</thead>
<tbody>
<tr>
<td>_SEH_prolog/_SEH_epilog</td>
<td>SEH3</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>_SEH_prolog4/_SEH_epilog4 S</td>
<td>EH4</td>
<td>+</td>
<td>-</td>
<td></td>
</tr>
<tr>
<td>_SEH_prolog4_GS/_SEH_epilog4_GS</td>
<td>SEH4</td>
<td>+</td>
<td>+</td>
<td></td>
</tr>
<tr>
<td>_EH_prolog</td>
<td>C++ EH</td>
<td>-</td>
<td>-</td>
<td>+/-</td>
</tr>
<tr>
<td>_EH_prolog3/_EH_epilog3</td>
<td>C++ EH</td>
<td>+</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>_EH_prolog3_catch/_EH_epilog3</td>
<td>C++ EH</td>
<td>+</td>
<td>-</td>
<td>+</td>
</tr>
<tr>
<td>_EH_prolog3_GS/_EH_epilog3_GS</td>
<td>C++ EH</td>
<td>+</td>
<td>+</td>
<td>-</td>
</tr>
<tr>
<td>_EH_prolog3_catch_GS/_EH_epilog3_catch_GS</td>
<td>C++ EH</td>
<td>+</td>
<td>+</td>
<td>+</td>
</tr>
</tbody>
</table>
<h2 id="SEH2"><a href="#SEH2" class="headerlink" title="SEH2"></a>SEH2</h2><p>当然，这个在早期的 <code>MSVC1.xx</code> 中才会用到（从 <code>crtdll.dll</code> 中导出），在一些运行在旧版 NT 上的程序中会碰到。其内存布局如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Saved edi</div><div class="line">Saved esi</div><div class="line">Saved ebx</div><div class="line">Next SEH frame</div><div class="line">Current SEH handler (__except_handler2)</div><div class="line">Pointer to the scopetable</div><div class="line">Try level</div><div class="line">Saved ebp (of this function)</div><div class="line">Exception pointers</div><div class="line">Local variables</div><div class="line">Saved ESP</div><div class="line">Local variables</div><div class="line">Callee EBP</div><div class="line">Return address</div><div class="line">Function arguments</div></pre></td></tr></table></figure>
<h2 id="附录-1：SEH-程序示例"><a href="#附录-1：SEH-程序示例" class="headerlink" title="附录 1：SEH 程序示例"></a>附录 1：SEH 程序示例</h2><p>参考以下反汇编出来的结果：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">func1           proc <span class="built_in">near</span></div><div class="line"></div><div class="line">_excCode        = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">28h</span></div><div class="line">buf             = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">24h</span></div><div class="line">_saved_esp      = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">18h</span></div><div class="line">_exception_info = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">14h</span></div><div class="line">_next           = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">10h</span></div><div class="line">_handler        = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">0Ch</span></div><div class="line">_scopetable     = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">8</span></div><div class="line">_trylevel       = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">4</span></div><div class="line"><span class="keyword">str</span>             = <span class="built_in">dword</span> <span class="built_in">ptr</span>  <span class="number">8</span></div><div class="line"></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span></div><div class="line">    <span class="keyword">push</span>    -<span class="number">1</span></div><div class="line">    <span class="keyword">push</span>    offset _func1_scopetable</div><div class="line">    <span class="keyword">push</span>    offset _except_handler3</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, large <span class="built_in">fs</span>:<span class="number">0</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     large <span class="built_in">fs</span>:<span class="number">0</span>, <span class="built_in">esp</span></div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, -<span class="number">18h</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ebx</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">esi</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edi</span></div><div class="line"></div><div class="line"><span class="comment">; --- end of prolog ---</span></div><div class="line"></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_trylevel], <span class="number">0</span> <span class="comment">;trylevel -1 -&gt; 0: beginning of try block 0</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_trylevel], <span class="number">1</span> <span class="comment">;trylevel 0 -&gt; 1: beginning of try block 1</span></div><div class="line">    <span class="keyword">mov</span>     large <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:<span class="number">123</span>, <span class="number">456</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_trylevel], <span class="number">0</span> <span class="comment">;trylevel 1 -&gt; 0: end of try block 1</span></div><div class="line">    <span class="keyword">jmp</span>     short _endoftry1</div><div class="line"><span class="symbol"></span></div><div class="line">_func1_filter1:   <span class="comment">; __except() filter of try block 1</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_exception_info]</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">edx</span>, [<span class="built_in">ecx</span>+EXCEPTION_POINTERS.ExceptionRecord]</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">edx</span>+EXCEPTION_RECORD.ExceptionCode]</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_excCode], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_excCode]</div><div class="line">    <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">cmp</span>     <span class="built_in">ecx</span>, EXCEPTION_ACCESS_VIOLATION</div><div class="line">    <span class="keyword">setz</span>    <span class="built_in">al</span></div><div class="line">    <span class="keyword">retn</span></div><div class="line"><span class="symbol"></span></div><div class="line">_func1_handler1:   <span class="comment">; beginning of handler for try block 1</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">esp</span>, [<span class="built_in">ebp</span>+_saved_esp]</div><div class="line">    <span class="keyword">push</span>    offset aAccessViolatio <span class="comment">; "Access violation"</span></div><div class="line">    <span class="keyword">call</span>    _printf</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">4</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_trylevel], <span class="number">0</span> <span class="comment">;trylevel 1 -&gt; 0: end of try block 1</span></div><div class="line"><span class="symbol"></span></div><div class="line">_endoftry1:</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">edx</span>, [<span class="built_in">ebp</span>+<span class="keyword">str</span>]</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edx</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+buf]</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">eax</span></div><div class="line">    <span class="keyword">call</span>    _strcpy</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">8</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_trylevel], -<span class="number">1</span> <span class="comment">; trylevel 0 -&gt; -1: end of try block 0</span></div><div class="line">    <span class="keyword">call</span>    _func1_handler0     <span class="comment">; execute __finally of try block 0</span></div><div class="line">    <span class="keyword">jmp</span>     short _endoftry0</div><div class="line"><span class="symbol"></span></div><div class="line">_func1_handler0:   <span class="comment">; __finally handler of try block 0</span></div><div class="line">    <span class="keyword">push</span>    offset aInFinally <span class="comment">; "in finally"</span></div><div class="line">    <span class="keyword">call</span>    _puts</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">4</span></div><div class="line">    <span class="keyword">retn</span></div><div class="line"><span class="symbol"></span></div><div class="line">_endoftry0:</div><div class="line">  <span class="comment">; --- epilog ---</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_next]</div><div class="line">    <span class="keyword">mov</span>     large <span class="built_in">fs</span>:<span class="number">0</span>, <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">edi</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">esi</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ebx</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">esp</span>, <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">retn</span></div><div class="line">func1 endp</div><div class="line"></div><div class="line">_func1_scopetable</div><div class="line">    <span class="comment">;try block 0</span></div><div class="line">    <span class="built_in">dd</span> -<span class="number">1</span>                      <span class="comment">;EnclosingLevel</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                       <span class="comment">;FilterFunc</span></div><div class="line">    <span class="built_in">dd</span> offset _func1_handler0  <span class="comment">;HandlerFunc</span></div><div class="line"></div><div class="line">    <span class="comment">;try block 1</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                       <span class="comment">;EnclosingLevel</span></div><div class="line">    <span class="built_in">dd</span> offset _func1_filter1   <span class="comment">;FilterFunc</span></div><div class="line">    <span class="built_in">dd</span> offset _func1_handler1  <span class="comment">;HandlerFunc</span></div></pre></td></tr></table></figure>
<p>注意，上面的 <code>0</code> 号 <code>try</code> 块并没有过滤器，所以它的处理句柄是 <code>__finally{}</code> 语句块。<code>try</code> 块 <code>1</code> 的 <code>EnclosingLevel</code> 是 <code>0</code>，所以它被 <code>0</code> 号 <code>try</code> 块所闭合。由此以来，我们可以大概构造出上面程序的大概结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span> <span class="params">(<span class="keyword">char</span>* str)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">char</span> buf[<span class="number">12</span>];</div><div class="line">  __try <span class="comment">// try block 0</span></div><div class="line">  &#123;</div><div class="line">     __try <span class="comment">// try block 1</span></div><div class="line">     &#123;</div><div class="line">       *(<span class="keyword">int</span>*)<span class="number">123</span>=<span class="number">456</span>;</div><div class="line">     &#125;</div><div class="line">     __except(GetExceptCode() == EXCEPTION_ACCESS_VIOLATION)</div><div class="line">     &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Access violation"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="built_in">strcpy</span>(buf,str);</div><div class="line">  &#125;</div><div class="line">  __finally</div><div class="line">  &#123;</div><div class="line">     <span class="built_in">puts</span>(<span class="string">"in finally"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="附录-2：带-SEH-异常的-C-程序示例"><a href="#附录-2：带-SEH-异常的-C-程序示例" class="headerlink" title="附录 2：带 SEH 异常的 C++ 程序示例"></a>附录 2：带 SEH 异常的 C++ 程序示例</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">func1           proc <span class="built_in">near</span></div><div class="line"></div><div class="line">_a1             = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">24h</span></div><div class="line">_exc            = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">20h</span></div><div class="line">e               = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">1Ch</span></div><div class="line">a2              = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">18h</span></div><div class="line">a1              = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">14h</span></div><div class="line">_saved_esp      = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">10h</span></div><div class="line">_next           = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">0Ch</span></div><div class="line">_handler        = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">8</span></div><div class="line">_state          = <span class="built_in">dword</span> <span class="built_in">ptr</span> -<span class="number">4</span></div><div class="line"></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span></div><div class="line">    <span class="keyword">push</span>    <span class="number">0FFFFFFFFh</span></div><div class="line">    <span class="keyword">push</span>    offset func1_ehhandler</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, large <span class="built_in">fs</span>:<span class="number">0</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     large <span class="built_in">fs</span>:<span class="number">0</span>, <span class="built_in">esp</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">14h</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ebx</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">esi</span></div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edi</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_saved_esp], <span class="built_in">esp</span></div><div class="line"></div><div class="line">    <span class="comment">; --- end of prolog ---</span></div><div class="line"></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line">    <span class="keyword">call</span>    A::A(void)</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_state], <span class="number">0</span>          <span class="comment">; state -1 -&gt; 0: a1 constructed</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+a1], <span class="number">1</span>              <span class="comment">; a1.m1 = 1</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+_state], <span class="number">1</span> <span class="comment">; state 0 -&gt; 1: try &#123;</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a2]</div><div class="line">    <span class="keyword">call</span>    A::A(void)</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_a1], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+_state], <span class="number">2</span> <span class="comment">; state 2: a2 constructed</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+a2], <span class="number">2</span>              <span class="comment">; a2.m1 = 2</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line">    <span class="keyword">cmp</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+a2]            <span class="comment">; a1.m1 == a2.m1?</span></div><div class="line">    <span class="keyword">jnz</span>     short loc_40109F</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_exc], offset aAbc  <span class="comment">; _exc = "abc"</span></div><div class="line">    <span class="keyword">push</span>    offset __TI1?PAD         <span class="comment">; char *</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_exc]</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">call</span>    _CxxThrowException       <span class="comment">; throw "abc";</span></div><div class="line"><span class="symbol"></span></div><div class="line">loc_40109F:</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+_state], <span class="number">1</span> <span class="comment">; state 2 -&gt; 1: destruct a2</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a2]</div><div class="line">    <span class="keyword">call</span>    A::~A(void)</div><div class="line">    <span class="keyword">jmp</span>     short func1_try0end</div><div class="line"></div><div class="line"><span class="comment">; catch (char * e)</span></div><div class="line"><span class="symbol">func1_try0handler_pchar:</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">edx</span>, [<span class="built_in">ebp</span>+e]</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edx</span></div><div class="line">    <span class="keyword">push</span>    offset aCaughtS <span class="comment">; "Caught %s\n"</span></div><div class="line">    <span class="keyword">call</span>    <span class="built_in">ds</span>:printf       <span class="comment">;</span></div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">8</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset func1_try0end</div><div class="line">    <span class="keyword">retn</span></div><div class="line"></div><div class="line"><span class="comment">; catch (...)</span></div><div class="line"><span class="symbol">func1_try0handler_ellipsis:</span></div><div class="line">    <span class="keyword">push</span>    offset aCaught___ <span class="comment">; "Caught ...\n"</span></div><div class="line">    <span class="keyword">call</span>    <span class="built_in">ds</span>:printf</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">4</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset func1_try0end</div><div class="line">    <span class="keyword">retn</span></div><div class="line"><span class="symbol"></span></div><div class="line">func1_try0end:</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_state], <span class="number">0</span>          <span class="comment">; state 1 -&gt; 0: &#125;//try</span></div><div class="line">    <span class="keyword">push</span>    offset aAfterTry <span class="comment">; "after try\n"</span></div><div class="line">    <span class="keyword">call</span>    <span class="built_in">ds</span>:printf</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">4</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+_state], -<span class="number">1</span>         <span class="comment">; state 0 -&gt; -1: destruct a1</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line">    <span class="keyword">call</span>    A::~A(void)</div><div class="line">    <span class="comment">; --- epilog ---</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_next]</div><div class="line">    <span class="keyword">mov</span>     large <span class="built_in">fs</span>:<span class="number">0</span>, <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">edi</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">esi</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ebx</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">esp</span>, <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ebp</span></div><div class="line">    <span class="keyword">retn</span></div><div class="line">func1           endp</div><div class="line"></div><div class="line">func1_ehhandler proc <span class="built_in">near</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset func1_funcinfo</div><div class="line">    <span class="keyword">jmp</span>     __CxxFrameHandler</div><div class="line">func1_ehhandler endp</div><div class="line"></div><div class="line">func1_funcinfo</div><div class="line">    <span class="built_in">dd</span> <span class="number">19930520h</span>            <span class="comment">; magicNumber</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">4</span>                    <span class="comment">; maxState</span></div><div class="line">    <span class="built_in">dd</span> offset func1_unwindmap <span class="comment">; pUnwindMap</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">1</span>                    <span class="comment">; nTryBlocks</span></div><div class="line">    <span class="built_in">dd</span> offset func1_trymap  <span class="comment">; pTryBlockMap</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; nIPMapEntries</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; pIPtoStateMap</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; pESTypeList</span></div><div class="line"></div><div class="line">func1_unwindmap</div><div class="line">    <span class="built_in">dd</span> -<span class="number">1</span></div><div class="line">    <span class="built_in">dd</span> offset func1_unwind_1tobase <span class="comment">; action</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; toState</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; action</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">1</span>                    <span class="comment">; toState</span></div><div class="line">    <span class="built_in">dd</span> offset func1_unwind_2to1 <span class="comment">; action</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; toState</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; action</span></div><div class="line"></div><div class="line">func1_trymap</div><div class="line">    <span class="built_in">dd</span> <span class="number">1</span>                    <span class="comment">; tryLow</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">2</span>                    <span class="comment">; tryHigh</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">3</span>                    <span class="comment">; catchHigh</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">2</span>                    <span class="comment">; nCatches</span></div><div class="line">    <span class="built_in">dd</span> offset func1_tryhandlers_0 <span class="comment">; pHandlerArray</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span></div><div class="line"></div><div class="line">func1_tryhandlers_0</div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; adjectives</span></div><div class="line">    <span class="built_in">dd</span> offset char * <span class="string">'RTTI Type Descriptor'</span> <span class="comment">; pType</span></div><div class="line">    <span class="built_in">dd</span> -<span class="number">1Ch</span>                 <span class="comment">; dispCatchObj</span></div><div class="line">    <span class="built_in">dd</span> offset func1_try0handler_pchar <span class="comment">; addressOfHandler</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; adjectives</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; pType</span></div><div class="line">    <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; dispCatchObj</span></div><div class="line">    <span class="built_in">dd</span> offset func1_try0handler_ellipsis <span class="comment">; addressOfHandler</span></div><div class="line"></div><div class="line">func1_unwind_1tobase proc <span class="built_in">near</span></div><div class="line">    a1 = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">14h</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line">    <span class="keyword">call</span>    A::~A(void)</div><div class="line">    <span class="keyword">retn</span></div><div class="line">func1_unwind_1tobase endp</div><div class="line"></div><div class="line">func1_unwind_2to1 proc <span class="built_in">near</span></div><div class="line">    a2 = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">18h</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a2]</div><div class="line">    <span class="keyword">call</span>    A::~A(void)</div><div class="line">    <span class="keyword">retn</span></div><div class="line">func1_unwind_2to1 endp</div></pre></td></tr></table></figure>
<p>我们来看上述程序示例，<code>FuncInfo</code> 结构体中的 <code>maxState</code> 域值为 <code>4</code>，这表明<strong>栈展开映射表</strong>中有 <code>4</code> 个入口点，编号 <strong>0-3</strong> 。检查映射表，可以看到在栈展开过程中会执行的相应动作有以下 <code>4</code> 个：</p>
<blockquote>
<ul>
<li>state 3 -&gt; state 0 (NOP)</li>
<li>state 2 -&gt; state 1 (析构 <code>a2</code> )</li>
<li>state 1 -&gt; state 0 (NOP)</li>
<li>state 0 -&gt; state -1 (析构 <code>a1</code> )</li>
</ul>
</blockquote>
<p>再看 <code>try</code> 语句映射表，我们可以推断， <code>state 1</code> 和 <code>state2</code> 对应 <code>try</code> 语句块的执行逻辑，而 <code>sttate3</code> 对应 <code>catch</code> 语句块的执行逻辑。这样一来，<code>state 0 -&gt; 1</code> 的变化代表了 <code>try</code> 语句块的<strong>开始</strong>，<code>state 1 - &gt;0</code> 代表 <code>try</code> 语句块的<strong>结束</strong>。另外，我们还可以推断 <code>state -1 --&gt; 0</code> 代表创建 <code>a1</code>；<code>state 1 -&gt; 2</code> 代表创建 <code>a2</code>。具体的状态装换和相应的程序执行逻辑如下图所示：<br><img src="/imgs/14932976893461.gif" alt=""><br>看到这里可能会心生疑惑：<code>1 -&gt; 3</code> 那个箭头是从哪儿来的？其实这是在异常处理句柄内部发生的，我们从<strong>函数代码</strong>和 <code>FuncInfo</code> 结构体中都看不出来罢了。如果一个异常在 <code>try</code> 块内部被触发，异常处理句柄在调用相应的 <code>catch</code> 块之前，首先要做的就是把栈展开到 <code>tryLow</code> 那一层（上面例子中的 <code>state 1</code>），然后把状态值 <code>state</code> 设置为 <code>tryHigh+1</code>（即 <code>2+1=3</code>）。</p>
<p><code>try</code> 语句块对应 2 个 <code>catch</code> 句柄。第一个有一个 <code>catch</code> 的类型（ <code>char*</code> ），并且在栈 <code>-1Ch</code> 处获取到异常对象。第二个没有对应的异常类型，什么也不做，相当于忽略异常。两个句柄都会返回函数继续执行的地址，这个地址其实就紧随 <code>try</code> 块之后。这样我们试着还原一下该函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span> <span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    A a1;</div><div class="line">    a1.m1 = <span class="number">1</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        A a2;</div><div class="line">        a2.m1 = <span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (a1.m1 == a1.m2) <span class="keyword">throw</span> <span class="string">"abc"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span>(<span class="keyword">char</span>* e)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Caught %s\n"</span>,e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span>(...)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Caught ...\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"after try\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="附录-3-IDC-辅助脚本"><a href="#附录-3-IDC-辅助脚本" class="headerlink" title="附录 3: IDC 辅助脚本"></a>附录 3: IDC 辅助脚本</h2><p>我编写了一个 IDC 脚本用来辅助对 MSVC 程序的逆向分析。它会在整个程序中搜索 SEH/EH 的代码段，并且为所有相关的结构体和结构体元素添加注释。可以被注释的项有<strong>栈变量</strong>、<strong>异常处理句柄</strong>、<strong>异常类型</strong>及其他相关元素。它还能尝试修复 IDA 中误判的函数边界。该脚本的下载链接： <a href="http://www.openrce.org/downloads/details/196" target="_blank" rel="external">MS SEH/EH 逆向辅助脚本</a> 。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="原文参考资料："><a href="#原文参考资料：" class="headerlink" title="原文参考资料："></a>原文参考资料：</h3><ol>
<li><a href="http://www.microsoft.com/msj/0197/exception/exception.aspx" target="_blank" rel="external">http://www.microsoft.com/msj/0197/exception/exception.aspx</a></li>
<li><a href="http://blogs.msdn.com/branbray/archive/2003/11/11/51012.aspx" target="_blank" rel="external">http://blogs.msdn.com/branbray/archive/2003/11/11/51012.aspx</a></li>
<li><a href="http://blogs.msdn.com/cbrumme/archive/2003/10/01/51524.aspx" target="_blank" rel="external">http://blogs.msdn.com/cbrumme/archive/2003/10/01/51524.aspx</a></li>
<li><a href="http://www.codeproject.com/cpp/exceptionhandler.asp" target="_blank" rel="external">http://www.codeproject.com/cpp/exceptionhandler.asp</a></li>
<li><a href="http://www.cs.arizona.edu/computer.help/policy/DIGITAL_unix/AA-PY8AC-TET1_html/callCH5.html" target="_blank" rel="external">http://www.cs.arizona.edu/computer.help/policy/DIGITAL_unix/AA-PY8AC-TET1_html/callCH5.html</a></li>
</ol>
<h3 id="翻译参考资料"><a href="#翻译参考资料" class="headerlink" title="翻译参考资料"></a>翻译参考资料</h3><ol>
<li><a href="http://www.cnblogs.com/samo/articles/3092895.html" target="_blank" rel="external">http://www.cnblogs.com/samo/articles/3092895.html</a></li>
<li><a href="http://www.cnblogs.com/Winston/archive/2009/04/19/1439184.html" target="_blank" rel="external">http://www.cnblogs.com/Winston/archive/2009/04/19/1439184.html</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/8dbf701c(v=vs.80).aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/8dbf701c(v=vs.80).aspx</a></li>
<li><a href="http://www.nynaeve.net/?p=91" target="_blank" rel="external">http://www.nynaeve.net/?p=91</a></li>
<li><a href="http://www.cnblogs.com/awpatp/archive/2009/11/04/1595988.html" target="_blank" rel="external">http://www.cnblogs.com/awpatp/archive/2009/11/04/1595988.html</a></li>
<li><a href="https://en.wikibooks.org/wiki/C%2B%2B_Programming/RTTI" target="_blank" rel="external">https://en.wikibooks.org/wiki/C%2B%2B_Programming/RTTI</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div><font color="green">看得爽的话，赞助个地铁通勤费？</font></div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/imgs/wechat.png" alt="0xjiayu WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/imgs/alipay.png" alt="0xjiayu Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <div style="MARGIN-TOP: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px">
    <IMG alt="" src="https://avatars3.githubusercontent.com/u/4980416?v=3&s=140" width=120 height=120>
  </div>
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>Post author:</strong>
      <a href="mailto:jiayu0x@gmail.com"> 0xjiayu </a>
    </li>
    <li class="post-copyright-link">
      <strong>Post link:</strong>
      <a href="http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/" title="(译)MSVC++ 逆向(一) —— 异常处理">http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright Notice: </strong>
      All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/security/" rel="tag"># security</a>
          
            <a href="/tags/c/" rel="tag"># c++</a>
          
            <a href="/tags/re/" rel="tag"># re</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/27/flume-summary/" rel="next" title="Flume 踩坑排雷记">
                <i class="fa fa-chevron-left"></i> Flume 踩坑排雷记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/30/reversing-msvcxx-exception-handling-2/" rel="prev" title="(译)MSVC++ 逆向（二）—— 类、方法和 RTTI">
                (译)MSVC++ 逆向（二）—— 类、方法和 RTTI <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="0xjiayu" />
          <p class="site-author-name" itemprop="name">0xjiayu</p>
           
              <p class="site-description motion-element" itemprop="description">About Security/Coding…… and life.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#摘要"><span class="nav-number">1.</span> <span class="nav-text">摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#栈的内存布局"><span class="nav-number">2.</span> <span class="nav-text">栈的内存布局</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SEH"><span class="nav-number">3.</span> <span class="nav-text">SEH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#栈越界（溢出）保护"><span class="nav-number">4.</span> <span class="nav-text">栈越界（溢出）保护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-异常模型实现"><span class="nav-number">5.</span> <span class="nav-text">C++ 异常模型实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#抛出-C-异常"><span class="nav-number">6.</span> <span class="nav-text">抛出 C++ 异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#序言-与-结语（Prologs-amp-Epilogs）"><span class="nav-number">7.</span> <span class="nav-text">序言 与 结语（Prologs & Epilogs）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SEH2"><span class="nav-number">8.</span> <span class="nav-text">SEH2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录-1：SEH-程序示例"><span class="nav-number">9.</span> <span class="nav-text">附录 1：SEH 程序示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录-2：带-SEH-异常的-C-程序示例"><span class="nav-number">10.</span> <span class="nav-text">附录 2：带 SEH 异常的 C++ 程序示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录-3-IDC-辅助脚本"><span class="nav-number">11.</span> <span class="nav-text">附录 3: IDC 辅助脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">12.</span> <span class="nav-text">参考资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原文参考资料："><span class="nav-number">12.1.</span> <span class="nav-text">原文参考资料：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#翻译参考资料"><span class="nav-number">12.2.</span> <span class="nav-text">翻译参考资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>

    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xjiayu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jiayu0x.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/';
          this.page.identifier = '2017/04/25/reversing-msvcxx-exception-handling/';
          this.page.title = '(译)MSVC++ 逆向(一) —— 异常处理';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://jiayu0x.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  


</body>
</html>
