<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="qBZOdQGNufiwjuoePxh48OOtXbE2OcD2yxZE6tLxrsM" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="http://apps.bdimg.com/libs/webfont/1.3.0/webfont_debug.js/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="security,c++,re," />





  <link rel="alternate" href="/atom.xml" title="JiaYu's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="ÂéüÊñáÔºö http://www.openrce.org/articles/full_view/23

ËøôÊòØÊú¨Á≥ªÂàóÁ¨¨‰∫åÁØáÔºàÁ¨¨‰∏ÄÁØá üëâÔºö MSVC++ ÈÄÜÂêë(1)‚Äî‚ÄîÂºÇÂ∏∏Â§ÑÁêÜ ÔºâÔºåÊú¨ÁØáÂ∞Ü‰ªãÁªç MSVC ‰∏≠ÂÆûÁé∞ÁöÑ C++ Â∫ïÂ±ÇÊú∫Âà∂ÔºåÂåÖÊã¨ÈÄÜÂêëËøáÁ®ã‰∏≠ÁöÑ Á±ªÁªìÊûÑÂÜÖÂ≠òÂ∏ÉÂ±Ä„ÄÅËôöÂáΩÊï∞„ÄÅRTTIÔºàRun-Time Type InformationÔºåËøêË°åÊó∂Á±ªÂûãËØÜÂà´Ôºâ„ÄÇÈòÖËØªÊú¨ÊñáÈúÄË¶ÅÊúâ C++ Âü∫Á°ÄÁü•ËØÜ‰ª•ÂèäÊ±áÁºñÂíåÈÄÜÂêëÁõ∏ÂÖ≥">
<meta property="og:type" content="article">
<meta property="og:title" content="(ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI">
<meta property="og:url" content="http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/index.html">
<meta property="og:site_name" content="JiaYu's Blog">
<meta property="og:description" content="ÂéüÊñáÔºö http://www.openrce.org/articles/full_view/23

ËøôÊòØÊú¨Á≥ªÂàóÁ¨¨‰∫åÁØáÔºàÁ¨¨‰∏ÄÁØá üëâÔºö MSVC++ ÈÄÜÂêë(1)‚Äî‚ÄîÂºÇÂ∏∏Â§ÑÁêÜ ÔºâÔºåÊú¨ÁØáÂ∞Ü‰ªãÁªç MSVC ‰∏≠ÂÆûÁé∞ÁöÑ C++ Â∫ïÂ±ÇÊú∫Âà∂ÔºåÂåÖÊã¨ÈÄÜÂêëËøáÁ®ã‰∏≠ÁöÑ Á±ªÁªìÊûÑÂÜÖÂ≠òÂ∏ÉÂ±Ä„ÄÅËôöÂáΩÊï∞„ÄÅRTTIÔºàRun-Time Type InformationÔºåËøêË°åÊó∂Á±ªÂûãËØÜÂà´Ôºâ„ÄÇÈòÖËØªÊú¨ÊñáÈúÄË¶ÅÊúâ C++ Âü∫Á°ÄÁü•ËØÜ‰ª•ÂèäÊ±áÁºñÂíåÈÄÜÂêëÁõ∏ÂÖ≥">
<meta property="og:image" content="http://jiayu0x.com/imgs/14936061421938.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14938199737802.jpg">
<meta property="og:image" content="http://jiayu0x.com/imgs/14938205753585.jpg">
<meta property="og:updated_time" content="2017-05-04T13:48:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI">
<meta name="twitter:description" content="ÂéüÊñáÔºö http://www.openrce.org/articles/full_view/23

ËøôÊòØÊú¨Á≥ªÂàóÁ¨¨‰∫åÁØáÔºàÁ¨¨‰∏ÄÁØá üëâÔºö MSVC++ ÈÄÜÂêë(1)‚Äî‚ÄîÂºÇÂ∏∏Â§ÑÁêÜ ÔºâÔºåÊú¨ÁØáÂ∞Ü‰ªãÁªç MSVC ‰∏≠ÂÆûÁé∞ÁöÑ C++ Â∫ïÂ±ÇÊú∫Âà∂ÔºåÂåÖÊã¨ÈÄÜÂêëËøáÁ®ã‰∏≠ÁöÑ Á±ªÁªìÊûÑÂÜÖÂ≠òÂ∏ÉÂ±Ä„ÄÅËôöÂáΩÊï∞„ÄÅRTTIÔºàRun-Time Type InformationÔºåËøêË°åÊó∂Á±ªÂûãËØÜÂà´Ôºâ„ÄÇÈòÖËØªÊú¨ÊñáÈúÄË¶ÅÊúâ C++ Âü∫Á°ÄÁü•ËØÜ‰ª•ÂèäÊ±áÁºñÂíåÈÄÜÂêëÁõ∏ÂÖ≥">
<meta name="twitter:image" content="http://jiayu0x.com/imgs/14936061421938.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","d#isplay":"post","display":"hide","offset":12,"offset_float":0,"b2t":true,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/"/>





  <title> (ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI | JiaYu's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-96776353-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?48422440cafd0d34da02c8973715c008";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JiaYu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Êµ™‰∫∫</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0xjiayu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JiaYu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                (ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-30T00:00:00+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index">
                    <span itemprop="name">security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/reversing-msvcxx-exception-handling-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/reversing-msvcxx-exception-handling-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>ÂéüÊñáÔºö <a href="http://www.openrce.org/articles/full_view/23" target="_blank" rel="external">http://www.openrce.org/articles/full_view/23</a></p>
</blockquote>
<p>ËøôÊòØÊú¨Á≥ªÂàóÁ¨¨‰∫åÁØáÔºàÁ¨¨‰∏ÄÁØá üëâÔºö <a href="http://jiayu0x.com/2017/04/25/reversing-msvcxx-exception-handling/">MSVC++ ÈÄÜÂêë(1)‚Äî‚ÄîÂºÇÂ∏∏Â§ÑÁêÜ</a> ÔºâÔºåÊú¨ÁØáÂ∞Ü‰ªãÁªç MSVC ‰∏≠ÂÆûÁé∞ÁöÑ C++ Â∫ïÂ±ÇÊú∫Âà∂ÔºåÂåÖÊã¨ÈÄÜÂêëËøáÁ®ã‰∏≠ÁöÑ <strong>Á±ªÁªìÊûÑÂÜÖÂ≠òÂ∏ÉÂ±Ä</strong>„ÄÅ<strong>ËôöÂáΩÊï∞</strong>„ÄÅ<strong>RTTI</strong>Ôºà<strong>Run-Time Type Information</strong>ÔºåËøêË°åÊó∂Á±ªÂûãËØÜÂà´Ôºâ„ÄÇÈòÖËØªÊú¨ÊñáÈúÄË¶ÅÊúâ C++ Âü∫Á°ÄÁü•ËØÜ‰ª•ÂèäÊ±áÁºñÂíåÈÄÜÂêëÁõ∏ÂÖ≥Âü∫Á°Ä„ÄÇ</p>
<a id="more"></a>
<h2 id="Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä"><a href="#Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä" class="headerlink" title="Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä"></a>Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä</h2><p>‰∏∫‰∫ÜÊñπ‰æøÈòêËø∞Êé•‰∏ãÊù•ÁöÑÂÜÖÂÆπÔºåÂÖàÁúã‰∏ÄÊÆµÁÆÄÂçïÁöÑ C++ ‰ª£Á†ÅÁ§∫‰æãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> A</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> a1;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">A_virt1</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">A_virt2</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">A_static1</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">A_simple1</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">class</span> B</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> b1;</div><div class="line">    <span class="keyword">int</span> b2;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">B_virt1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">B_virt2</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">class</span> C: <span class="keyword">public</span> A, <span class="keyword">public</span> B</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> c1;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">A_virt2</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">B_virt2</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Â§öÊï∞ÊÉÖÂÜµ‰∏ã MSVC++ ÁöÑ <strong>Á±ª</strong> ‰∏≠‰∏™ÂÖÉÁ¥†Âú®ÂÜÖÂ≠òÂ∏ÉÂ±Ä‰∏≠ÁöÑÈ°∫Â∫èÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÊåáÂêë<strong>ËôöÂáΩÊï∞Ë°®</strong>ÁöÑ<strong>ÊåáÈíà</strong>Ôºà <code>_vtable_</code> ÊàñËÄÖ <code>_vftable_</code> ÔºâÔºå‰ªÖÂΩìÁ±ª‰∏≠Êúâ<strong>ËôöÂáΩÊï∞</strong>„ÄÅÂπ∂‰∏î<strong>Âü∫Á±ª</strong>‰∏≠Ê≤°ÊúâÁõ∏Â∫îÁöÑ<strong>ËôöÂáΩÊï∞Ë°®</strong>ÁöÑÊó∂ÂÄôÊâçÊúâÊ≠§ÊåáÈíàÂÖÉÁ¥†Ôºõ</li>
<li>Âü∫Á±ª</li>
<li>Á±ªÊàêÂëò</li>
</ul>
<p><strong>ËôöÂáΩÊï∞Ë°®</strong>‰∏≠ÂõäÊã¨‰∫ÜÁ±ª‰∏≠ÁöÑÂêÑ‰∏™<strong>ËôöÂáΩÊï∞</strong>Ôºå‰ª•ËôöÂáΩÊï∞Â£∞ÊòéÁöÑÈ°∫Â∫èÊéíÂàó„ÄÇÂÖ∂‰∏≠Ôºå<strong>ÈáçËΩΩÂáΩÊï∞</strong> ÁöÑ <strong>Âú∞ÂùÄ</strong> Ë¶ÜÁõñÂü∫Á±ª‰∏≠Áõ∏Â∫îÂáΩÊï∞ÁöÑÂú∞ÂùÄ„ÄÇÂ¶ÇÊ≠§‰∏ÄÊù•Ôºå‰∏äÈù¢ 3 ‰∏™Á±ªÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑÂ∏ÉÂ±ÄÂ§ßÊ¶ÇÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">class A size(8)</div><div class="line">       +---</div><div class="line">    0  | &#123;vfptr&#125;</div><div class="line">    4  | a1</div><div class="line">       +---</div><div class="line"></div><div class="line">A&apos;s vftable:</div><div class="line">    0  | &amp;A::A_virt1</div><div class="line">    4  | &amp;A::A_virt2</div><div class="line">-----------------------</div><div class="line"></div><div class="line">class B size(12):</div><div class="line">        +---</div><div class="line">    0   | &#123;vfptr&#125;</div><div class="line">    4   | b1</div><div class="line">    8   | b2</div><div class="line">        +---</div><div class="line"></div><div class="line">B&apos;s vftable:</div><div class="line">    0   | &amp;B::B_virt1</div><div class="line">    4   | &amp;B::B_virt2</div><div class="line">-----------------------</div><div class="line"></div><div class="line">class C size(24):</div><div class="line">         +---</div><div class="line">         | +--- (base class A)</div><div class="line">    0    | | &#123;vfptr&#125;</div><div class="line">    4    | | a1</div><div class="line">         | +---</div><div class="line">         | +--- (base class B)</div><div class="line">    8    | | &#123;vfptr&#125;</div><div class="line">    12   | | b1</div><div class="line">    16   | | b2</div><div class="line">         | +---</div><div class="line">    20   | c1</div><div class="line">         +---</div><div class="line"></div><div class="line">C&apos;s vftable for A:</div><div class="line">    0   | &amp;A::A_virt1</div><div class="line">    4   | &amp;C::A_virt2</div><div class="line"></div><div class="line">C&apos;s vftable for B:</div><div class="line">    0   | &amp;B::B_virt1</div><div class="line">    4   | &amp;C::B_virt2</div></pre></td></tr></table></figure>
<p>‰∏äÈù¢ÁöÑÂõæË°®ÊòØÂú® VC8 ‰∏≠Áî®‰∏Ä‰∏™ÊñáÊ°£‰∏≠Ê≤°ËØ¥ÊòéÁöÑÁºñËØëÈÄâÈ°πÁîüÊàêÁöÑÔºåÂØπ‰∫éÁºñËØëÂô®‰∫ßÁîüÁöÑÁ±ªÂÜÖÂ≠òÂ∏ÉÂ±ÄÂõæË°®ÔºåÁî® <code>-d1reportSingleClassLayout</code> ÁºñËØëÈÄâÈ°πÂèØ‰ª•Êü•ÁúãÂçï‰∏™Á±ªÁöÑÂ∏ÉÂ±ÄÂõæË°®ÔºõÁî® <code>-d1reportAllClassLayout</code> ÂèØ‰ª•Êü•ÁúãÊâÄÊúâÁ±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºàÂåÖÊã¨ÂÜÖÈÉ®ÁöÑ CRT Á±ªÔºâÔºåÂ∏ÉÂ±ÄÂõæË°®‰ºöÂú® <code>stdout</code> ‰∏≠ËæìÂá∫„ÄÇ</p>
<p>‰ªé‰∏äÈù¢ÁºñËØëÂô®ÁîüÊàêÁöÑÂõæË°®ÂèØ‰ª•ÁúãÂá∫ÔºåÁ±ª <code>C</code> ÈáåÊúâ‰∏§‰∏™ <strong>ËôöÂáΩÊï∞Ë°®</strong>ÔºåËøôÊòØÂõ†‰∏∫ÂÆÉÁªßÊâø‰∫Ü‰∏§‰∏™Âü∫Á±ªÔºåËÄå‰∏§‰∏™Âü∫Á±ªÂùáÊúâËá™Â∑±ÁöÑËôöÂáΩÊï∞ÊàêÂëò„ÄÇÂú®Á±ª C ÁöÑÁ¨¨‰∏Ä‰∏™ËôöÂáΩÊï∞Ë°®‰∏≠ÔºåËôöÂáΩÊï∞ <code>C::A_virt2()</code> ÁöÑÂú∞ÂùÄË¶ÜÁõñ‰∫ÜÂü∫Á±ª A Âú® C ‰∏≠Ê¥æÁîüÁöÑ <code>A_virt2()</code> ÁöÑÂú∞ÂùÄÔºõÁ±ª‰ººÂú∞ÔºåÂú®Á±ª C ÁöÑÁ¨¨‰∫å‰∏™ËôöÂáΩÊï∞Ë°®‰∏≠ÔºåËôöÂáΩÊï∞ <code>C::B_virt2()</code> ÁöÑÂú∞ÂùÄË¶ÜÁõñ‰∫ÜÂü∫Á±ª B Âú® C ‰∏≠Ê¥æÁîüÁöÑ <code>B_virt2()</code> ÁöÑÂú∞ÂùÄ„ÄÇ</p>
<h2 id="Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï"><a href="#Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï" class="headerlink" title="Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï"></a>Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï</h2><p>MSVC++ ‰∏≠ÁöÑÁ±ªÊñπÊ≥ïË∞ÉÁî®Êó∂ÔºåÈªòËÆ§ÈÅµÂÆà <code>_thiscall_</code> Ë∞ÉÁî®Á∫¶ÂÆö„ÄÇÈÄöËøáÁ±ªÁöÑÂØπË±°Ë∞ÉÁî®<strong>ÈùûÈùôÊÄÅÊàêÂëòÂáΩÊï∞</strong>Êàñ<strong>ÈùûÂÖ®Â±ÄÂáΩÊï∞Êó∂</strong>ÔºåÁ±ªÁöÑÂØπË±°Ëá™Ë∫´ÁöÑÂú∞ÂùÄÔºàÂç≥ <code>*this</code> ÊåáÈíàÁöÑÂÄºÔºâ‰ºö‰ª•<strong>ÈöêÂê´ÂèÇÊï∞</strong>ÁöÑÂΩ¢Âºè‰º†ÈÄíÁªôË¢´Ë∞ÉÁî®ÁöÑÁ±ªÁöÑÊàêÂëòÂáΩÊï∞ÔºåÈÄöÂ∏∏ÔºåËøô‰∏™ <code>*this</code> ÊåáÈíàÁöÑÂÄºÔºåÂ≠òÂÇ®Âú®ÂØÑÂ≠òÂô® <code>ecx</code> ‰∏≠„ÄÇÂú®ÂáΩÊï∞‰ΩìÁöÑÂÆûÁé∞‰∏≠ÔºåÁºñËØëÂô®ÈÄöÂ∏∏ÊääËøô‰∏™ÊåáÈíàÂÄºÂ°ûÂú®ÂÖ∂‰ªñÂØÑÂ≠òÂô®‰∏≠ÔºàÊØîÂ¶Ç <code>esi</code> Êàñ <code>edi</code> ÔºâÔºåÊàñËÄÖÁõ¥Êé•Â≠òÂÖ•Ê†à‰∏≠ÁöÑÊüê‰∏™ÂèòÈáèÔºåÁÑ∂ÂêéÂØπÂÖ∂‰ªñÊâÄÊúâÁ±ªÊàêÂëòÁöÑËÆøÈóÆÔºåÈÉΩÂü∫‰∫éËøô‰∏™Âú∞ÂùÄËøõË°åÁõ∏ÂØπÂØªÂùÄÊù•ÂÆûÁé∞„ÄÇÁÑ∂ËÄåÔºåÂΩìÂÆûÁé∞ <code>COM</code> Á±ªÁöÑÊó∂ÂÄôÔºåÂØπÁ±ªÊàêÂëòÂáΩÊï∞ÁöÑË∞ÉÁî®ÂàôÈÅµÂæ™ <code>_stdcall_</code> ÁöÑË∞ÉÁî®Á∫¶ÂÆö„ÄÇ‰∏ãÈù¢ËØ¶Ëø∞Âá†Áßç‰∏çÂêåÁöÑÁ±ªÊàêÂëòÊñπÊ≥ïË∞ÉÁî®Êó∂ÁöÑÂ∫ïÂ±ÇÁªÜËäÇÔºö</p>
<h3 id="1-ÈùôÊÄÅÊàêÂëòÂáΩÊï∞"><a href="#1-ÈùôÊÄÅÊàêÂëòÂáΩÊï∞" class="headerlink" title="1) ÈùôÊÄÅÊàêÂëòÂáΩÊï∞"></a>1) ÈùôÊÄÅÊàêÂëòÂáΩÊï∞</h3><p>Ë∞ÉÁî®<strong>ÈùôÊÄÅÊàêÂëòÂáΩÊï∞</strong>‰∏çÈúÄË¶ÅÁ±ªÁöÑÂÆû‰æãÂØπË±°ÔºåÂèØ‰ª•Áõ¥Êé•ÈÄöËøáÁ±ªÂêçÊù•Ë∞ÉÁî®ÔºåÂú®Â∫ïÂ±ÇÁúãÊù•Â∞±Ë∑üË∞ÉÁî®ÊôÆÈÄöÈùûÊàêÂëòÂáΩÊï∞Â∑Æ‰∏çÂ§öÔºåÂπ∂‰∏çÊ∂âÂèä <code>*this</code> ÊåáÈíàÁöÑÈöêÂºè‰º†ÈÄí„ÄÇ‰∏çËøáÔºå‰πüÊ≠£Âõ†Â¶ÇÊ≠§ÔºåÈÄÜÂêëËøáÁ®ã‰∏≠‰∏çÂÆπÊòìÂå∫ÂàÜÁ±ªÁöÑÈùôÊÄÅÊàêÂëòÂáΩÊï∞ÂíåÊôÆÈÄöÁöÑÈùûÊàêÂëòÂáΩÊï∞„ÄÇÊØîÂ¶ÇÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">A::A_static1();</div><div class="line">call    A::A_static1</div></pre></td></tr></table></figure>
<h3 id="2-ÊôÆÈÄöÊàêÂëòÂáΩÊï∞"><a href="#2-ÊôÆÈÄöÊàêÂëòÂáΩÊï∞" class="headerlink" title="2) ÊôÆÈÄöÊàêÂëòÂáΩÊï∞"></a>2) ÊôÆÈÄöÊàêÂëòÂáΩÊï∞</h3><p><strong>ÊôÆÈÄöÊàêÂëòÂáΩÊï∞</strong>ÁöÑË∞ÉÁî®ÔºåÂ∞±ÈúÄË¶ÅÈÄöËøáÁ±ªÁöÑÂÆû‰æãÂØπË±°Êù•Ë∞ÉÁî®‰∫ÜÔºåËøôÁßçÊÉÖÂÜµ‰∏ã <code>*this</code> ÊåáÈíà‰ºö‰ª•ÈöêÂê´ÂèÇÊï∞ÁöÑÂΩ¢Âºè‰Ωú‰∏∫Ë¢´Ë∞ÉÂáΩÊï∞ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞‰º†ÈÄíËøõÂéªÔºåÂπ∂ÈÅµÂæ™ <code>_thiscall_</code> Ë∞ÉÁî®Á∫¶ÂÆöÔºåÂú®Â∫ïÂ±Ç‰ºöÂ≠òÂÇ®Âú® <code>ecx</code> ÂØÑÂ≠òÂô®‰∏≠„ÄÇÂè¶Â§ñÔºåÂ¶ÇÊûúÂ≠òÂú®Á±ªÁªßÊâøÁöÑÊÉÖÂÜµÔºåÂü∫Á±ªÂØπË±°ÁöÑÂú∞ÂùÄÂèØËÉΩ‰∏éÊ¥æÁîüÁ±ªÁöÑÂØπË±°ÁöÑÂú∞ÂùÄ‰∏çÂêåÔºåËøôÊó∂ÂÄôÂ¶ÇÊûúÂú®Ê¥æÁîüÁ±ªÁöÑÂØπË±°‰∏≠Ë∞ÉÁî®Âü∫Á±ªÁöÑÊàêÂëòÂáΩÊï∞Ôºå <code>*this</code> ÊåáÈíàÁöÑÂÄºÈúÄË¶ÅË∞ÉÊï¥Âà∞<strong>Âü∫Á±ªÂØπË±°</strong>ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºåÁÑ∂ÂêéÊâçËÉΩË∞ÉÁî®Âü∫Á±ª‰∏≠ÁöÑÊôÆÈÄöÊàêÂëòÂáΩÊï∞„ÄÇÁ§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;pC-&gt;A_simple1(1);</span></div><div class="line"><span class="comment">;esi = pC</span></div><div class="line"><span class="keyword">push</span>    <span class="number">1</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">esi</span></div><div class="line"><span class="keyword">call</span>    A::A_simple1</div><div class="line"></div><div class="line"><span class="comment">;pC-&gt;B_simple1(2,3);</span></div><div class="line"><span class="comment">;esi = pC</span></div><div class="line"><span class="keyword">lea</span> <span class="built_in">edi</span>, [<span class="built_in">esi</span>+<span class="number">8</span>] <span class="comment">;Ë∞ÉÊï¥ *this ÊåáÈíàÁöÑÂÄº</span></div><div class="line"><span class="keyword">push</span>    <span class="number">3</span></div><div class="line"><span class="keyword">push</span>    <span class="number">2</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">edi</span></div><div class="line"><span class="keyword">call</span>    B::B_simple1</div></pre></td></tr></table></figure>
<p>Â¶Ç‰∏äÊâÄÁ§∫ÔºåÂú®Ë∞ÉÁî® <code>B</code> Á±ªÁöÑÊàêÂëòÂáΩÊï∞‰πãÂâçÔºå <code>*this</code> ÊåáÈíàÁöÑÂÄºË∞ÉÊï¥‰∏∫ <code>B</code> Á±ªÂ≠êÂØπË±°ÁöÑËµ∑ÂßãÂú∞ÂùÄ„ÄÇ</p>
<h3 id="3-ËôöÂáΩÊï∞"><a href="#3-ËôöÂáΩÊï∞" class="headerlink" title="3) ËôöÂáΩÊï∞"></a>3) ËôöÂáΩÊï∞</h3><p>‰∏∫‰∫ÜË∞ÉÁî®<strong>ËôöÂáΩÊï∞</strong>ÔºåÁºñËØëÂô®È¶ñÂÖàÈúÄË¶Å‰ªé<strong>ËôöÂáΩÊï∞Ë°®</strong>‰∏≠ÂèñÂá∫Áõ∏Â∫îËôöÂáΩÊï∞ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºåÁÑ∂ÂêéÂ∞±ÊåâÁÖßÁ±ª‰ººÊôÆÈÄöÊàêÂëòÂáΩÊï∞Ë∞ÉÁî®ÁöÑÊñπÂºèÂéªË∞ÉÁî®ÂÆÉÔºàÊää <code>*this</code> ÊåáÈíà‰ª•ÈöêÂê´ÂèÇÊï∞ÁöÑÊñπÂºè‰º†ÈÄíÔºâÔºåÁ§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;pC-&gt;A_virt2()</span></div><div class="line"><span class="comment">;esi = pC</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">esi</span>]  <span class="comment">;Ëé∑ÂèñËôöÂáΩÊï∞Ë°®ÁöÑÂú∞ÂùÄ</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">esi</span></div><div class="line"><span class="keyword">call</span> [<span class="built_in">eax</span>+<span class="number">4</span>]  <span class="comment">;Ë∞ÉÁî®ËôöÂáΩÊï∞Ë°®‰∏≠ÁöÑÁ¨¨‰∫å‰∏™ËôöÂáΩÊï∞</span></div><div class="line"></div><div class="line"><span class="comment">;pC-&gt;B_virt1()</span></div><div class="line"><span class="comment">;edi = pC</span></div><div class="line"><span class="keyword">lea</span> <span class="built_in">edi</span>, [<span class="built_in">esi</span>+<span class="number">8</span>] <span class="comment">;Ë∞ÉÊï¥ *this ÊåáÈíàÁöÑÂÄº</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">edi</span>]   <span class="comment">;Ëé∑ÂèñËôöÂáΩÊï∞Ë°®ÁöÑÂú∞ÂùÄ</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">edi</span></div><div class="line"><span class="keyword">call</span> [<span class="built_in">eax</span>]       <span class="comment">;Ë∞ÉÁî®Á¨¨‰∏Ä‰∏™ËôöÂáΩÊï∞</span></div></pre></td></tr></table></figure>
<h3 id="4-ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞"><a href="#4-ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞" class="headerlink" title="4) ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞"></a>4) ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞</h3><p><strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>Âíå<strong>ÊûêÊûÑÂáΩÊï∞</strong>ÁöÑË∞ÉÁî®ËøáÁ®ãÔºå‰∏éÊôÆÈÄöÊàêÂëòÂáΩÊï∞Á±ª‰ºº„ÄÇ‰∏çÂêåÁöÑÊòØÔºåÂç≥‰ΩøÊåâÊÉØ‰æãÊù•ËØ¥ÊûÑÈÄ†ÂáΩÊï∞Âπ∂Ê≤°ÊúâËøîÂõûÂÄºÔºåÂÆÉ‰ªçÁÑ∂‰ºöÊääÊûÑÈÄ†Â•ΩÁöÑÁ±ªÁöÑÂÆû‰æãÂØπË±°ÁöÑËµ∑ÂßãÂú∞ÂùÄÈöêÂºèÂú∞ËøîÂõûÔºà<code>return</code> Âà∞ÂØÑÂ≠òÂô® <code>eax</code> ‰∏≠Ôºâ„ÄÇ</p>
<h2 id="RTTI-ÁöÑÂÆûÁé∞"><a href="#RTTI-ÁöÑÂÆûÁé∞" class="headerlink" title="RTTI ÁöÑÂÆûÁé∞"></a>RTTI ÁöÑÂÆûÁé∞</h2><p><strong>RTTI</strong>ÔºàRun-Time Type IdentificationÔºå<strong>ËøêË°åÊó∂Á±ªÂûãËØÜÂà´</strong>ÔºâÊòØÁºñËØëÂô®‰∏∫‰∫ÜÊîØÊåÅ C++ ‰∏≠ <code>dynamic_cast&lt;&gt;</code> Âíå <code>typeid()</code> ‰∏§‰∏™Êìç‰ΩúÁ¨¶Êìç‰ΩúÁ¨¶‰ª•Âèä C++ ÂºÇÂ∏∏ËÄåÁîüÊàêÁöÑÁâπÊÆäÁºñËØë‰ø°ÊÅØ„ÄÇRTTI ÁöÑÁâπÊÄßÂè™ÊúâÂΩìÁ±ªÊ∂âÂèä<strong>Â§öÊÄÅ</strong>ÁöÑÊó∂ÂÄôÊâç‰ºöÁî®Âà∞ÔºåÊØîÂ¶ÇÁ±ª‰∏≠Â£∞Êòé‰∫Ü<strong>ËôöÂáΩÊï∞</strong>„ÄÇ</p>
<p>Âú®Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±Ä‰∏≠ÔºåMSVC ÁºñËØëÂô®‰ºöÊää‰∏Ä‰∏™ÊåáÂêë <strong><code>COL</code></strong>ÔºàComplete Object LocatorÔºå<strong>ÂÆåÊï¥ÂØπË±°ÂÆö‰ΩçÁ¨¶</strong>ÔºâÁªìÊûÑ‰ΩìÁöÑÊåáÈíàÊîæÂú®<strong>ËôöÂáΩÊï∞Ë°®</strong>‰πãÂâç„ÄÇ‰πãÊâÄ‰ª•Âè´<strong>ÂÆåÊï¥ÂØπË±°ÂÆö‰ΩçÁ¨¶</strong>ÔºåÊòØÂõ†‰∏∫ÂÆÉÂÖÅËÆ∏ÁºñËØëÂô®Ê†πÊçÆ‰∏Ä‰∏™ÁâπÂÆöÁöÑ<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ôºà‰∏Ä‰∏™Á±ª‰∏≠ÂèØËÉΩÊúâÂ§ö‰∏™<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>ÔºâÂÆö‰ΩçÂà∞Êï¥‰∏™ÂØπË±°„ÄÇ<strong>COL</strong>ÁöÑÁªìÊûÑÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> RTTICompleteObjectLocator</div><div class="line">&#123;</div><div class="line">    DWORD signature;  <span class="comment">// ‰∏ÄÁõ¥‰∏∫ 0 ?</span></div><div class="line">    DWORD offset;       <span class="comment">// ÊîπËôöÂáΩÊï∞Ë°®Âú®Á±ª‰∏≠Áõ∏ÂØπ‰∏éÁ±ªÁöÑËµ∑ÂßãÂú∞ÂùÄÁöÑÂÅèÁßªÈáèÔºàoffset of this vtable in the complete classÔºâ</span></div><div class="line">    DWORD cdOffset;   <span class="comment">// ÊûÑÈÄ†ÂáΩÊï∞ÂÅèÁßªÔºàconstructor displacement offsetÔºâ</span></div><div class="line">    <span class="keyword">struct</span> TypeDescriptor* pTypeDescriptor;  <span class="comment">// Êï¥‰∏™Á±ªÁöÑÁ±ªÂûãÊèèËø∞Á¨¶ÔºàTypeDescriptor of the complete classÔºâ</span></div><div class="line">    <span class="keyword">struct</span> RTTIClassHierarchyDescriptor* pClassDescriptor;  <span class="comment">// Á±ªÁöÑÁªßÊâøÂÖ≥Á≥ªÊèèËø∞ÁªìÊûÑÔºàdescribes inheritance hierarchyÔºâ</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>RTTIClassHierarchyDescriptor</code> ÊèèËø∞Êï¥‰∏™Á±ªÁöÑÁªßÊâøÂÖ≥Á≥ªÔºåÂÆÉÂØπÁ±ªÁöÑÊâÄÊúâ <code>COL</code> ÈÉΩÊòØÈÄöÁî®ÁöÑ„ÄÇ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> RTTIClassHierarchyDescriptor</div><div class="line">&#123;</div><div class="line">    DWORD signature;      <span class="comment">// ‰∏ÄÁõ¥‰∏∫ 0 ?</span></div><div class="line">    DWORD attributes;     <span class="comment">//bit 0 set = Â§öÈáçÁªßÊâø, bit 1 set = ËôöÁªßÊâø</span></div><div class="line">    DWORD numBaseClasses; <span class="comment">// pBaseClassArray ‰∏≠ÁöÑÂü∫Á±ªÊï∞ÈáèÔºànumber of classes in pBaseClassArrayÔºâ</span></div><div class="line">    <span class="keyword">struct</span> RTTIBaseClassArray* pBaseClassArray;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Base Class Array</code> ÂÆö‰πâ‰∫ÜÂú®ÊâßË°å <code>_dynamic_cast_</code> Êó∂<strong>Ê¥æÁîüÁ±ª</strong>ÂèØ‰ª•Âä®ÊÄÅÊò†Â∞ÑÊàêÁöÑÊâÄÊúâ<strong>Âü∫Á±ª</strong>ÁöÑ‰ø°ÊÅØÔºåÂÖ∂‰∏≠ÊØè‰∏Ä‰∏™<strong>Âü∫Á±ªÊèèËø∞Á¨¶</strong>ÔºàBase Class DescriptorÔºâÁöÑÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> RTTIBaseClassDescriptor</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> TypeDescriptor* pTypeDescriptor; <span class="comment">// Á±ªÁöÑÁ±ªÂûãÊèèËø∞Á¨¶Ôºàtype descriptor of the classÔºâ</span></div><div class="line">    DWORD numContainedBases; <span class="comment">// Base Class Array ‰∏≠ÁöÑÂü∫Á±ªÊï∞ÈáèÔºànumber of nested classes following in the Base Class ArrayÔºâ</span></div><div class="line">    <span class="keyword">struct</span> PMD where;        <span class="comment">// ÂÜÖÈÉ®ÊàêÂëòÂÅèÁßª‰ø°ÊÅØÔºàpointer-to-member displacement infoÔºâ</span></div><div class="line">    DWORD attributes;        <span class="comment">// Ê†áÂøó‰Ωç, ÈÄöÂ∏∏ÁΩÆ 0</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> PMD</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> mdisp;  <span class="comment">// ÂÜÖÈÉ®ÊàêÂëòÂÅèÁßªÔºàmember displacementÔºâ</span></div><div class="line">    <span class="keyword">int</span> pdisp;  <span class="comment">// ËôöÂáΩÊï∞Ë°®ÁöÑÂÅèÁßªÔºàvbtable displacementÔºâ</span></div><div class="line">    <span class="keyword">int</span> vdisp;  <span class="comment">// ËôöÂáΩÊï∞Ë°®ÁöÑÂÜÖÈÉ®ÂÅèÁßªÔºàdisplacement inside vbtableÔºâ</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>PMD</code> ÁªìÊûÑÊèèËø∞‰∏Ä‰∏™<strong>Âü∫Á±ª</strong>Âú®ÂÖ∂<strong>Ê¥æÁîüÁ±ª</strong>‰∏≠ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ„ÄÇ<strong>ÁÆÄÂçïÁªßÊâø</strong>ÁöÑÊó∂ÂÄôÔºå<strong>Âü∫Á±ª</strong>Áõ∏ÂØπ‰∫éÂÖ∂<strong>Ê¥æÁîüÁ±ª</strong>ÁöÑ<strong>ÂÅèÁßªÈáè</strong>ÊòØÂõ∫ÂÆöÁöÑÔºåÂÅèÁßªÈáèÁöÑÂÄºÂç≥ <code>_mdisp_</code> ÁöÑÂÄºÔºõÂ¶ÇÊûúÊ∂âÂèäÂà∞<strong>ËôöÁªßÊâø</strong>ÔºåÂ∞±ÈúÄË¶ÅÂÖà‰ªé<strong>ËôöÂáΩÊï∞Ë°®</strong>‰∏≠ÂèñÂá∫‰∏Ä‰∏™È¢ùÂ§ñÁöÑÂÅèÁßªÈáè‰∏ÄËµ∑ËÆ°ÁÆóÂá∫Âü∫Á±ªÁöÑÂÅèÁßªÔºåÂú®ÂáΩÊï∞Ë∞ÉÁî®ÁöÑÊó∂ÂÄôÂàôÈúÄË¶ÅÈáçÊñ∞Ë∞ÉÊï¥ <code>*this</code> ÊåáÈíàÁöÑÂÄº„ÄÇÊï¥‰∏™ËøáÁ®ãÁöÑ‰º™Á†ÅÁ§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//char* pThis; struct PMD pmd;</span></div><div class="line">pThis += pmd.mdisp;</div><div class="line"><span class="keyword">if</span> (pmd.pdisp != <span class="number">-1</span>)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">char</span> *vbtable = pThis + pmd.pdisp;</div><div class="line">  pThis += *(<span class="keyword">int</span>*)(vbtable + pmd.vdisp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰∏æ‰æãÊù•ËØ¥ÔºåÊñáÁ´†ÂºÄÂ§¥ 3 ‰∏™Á±ªÁöÑÁªßÊâøÂÖ≥Á≥ª‰∏≠ RTTI ÁöÑ‰ø°ÊÅØÂõæ‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="/imgs/14936061421938.jpg" alt="Á§∫‰æãlÁ±ª‰∏≠ÁöÑ RTTI ÁªßÊâøÂÖ≥Á≥ª"></p>
<h2 id="‰ø°ÊÅØÊèêÂèñ"><a href="#‰ø°ÊÅØÊèêÂèñ" class="headerlink" title="‰ø°ÊÅØÊèêÂèñ"></a>‰ø°ÊÅØÊèêÂèñ</h2><h3 id="1-RTTI"><a href="#1-RTTI" class="headerlink" title="1) RTTI"></a>1) RTTI</h3><p>Â¶ÇÊûúÂ≠òÂú® <strong>RTTI</strong>ÔºåÈÇ£‰πà <strong>RTTI</strong> ËÉΩ‰∏∫ÈÄÜÂêëÂ∑•‰ΩúÊèê‰æõÂæàÂ§öÊúâ‰ª∑ÂÄºÁöÑ‰ø°ÊÅØ„ÄÇÊ†πÊçÆ <strong>RTTI</strong>ÔºåÊàë‰ª¨ÂèØËÉΩËøòÂéü<strong>Á±ªÂêç</strong>„ÄÅ<strong>Á±ªÁöÑÁªßÊâøÂÖ≥Á≥ª</strong>ÔºåÁîöËá≥ÊúâÊó∂ÂÄôËÉΩËøòÂéüÈÉ®ÂàÜÁ±ªÁöÑ<strong>ÂÜÖÂ≠òÂ∏ÉÂ±Ä</strong>‰ø°ÊÅØ„ÄÇÂú® <strong>ÈôÑÂΩï 1</strong> ‰∏≠ÔºåÊàëÂÜô‰∫Ü‰∏Ä‰∏™ <strong>RTTI ‰ø°ÊÅØÊâ´ÊèèÂô®</strong>ÔºåÂèØ‰ª•ÂÅöËøõ‰∏ÄÊ≠•ÂèÇËÄÉ„ÄÇ</p>
<h3 id="2-ÈùôÊÄÅÂàùÂßãÂåñ-Âíå-ÂÖ®Â±ÄÂàùÂßãÂåñ"><a href="#2-ÈùôÊÄÅÂàùÂßãÂåñ-Âíå-ÂÖ®Â±ÄÂàùÂßãÂåñ" class="headerlink" title="2) ÈùôÊÄÅÂàùÂßãÂåñ Âíå ÂÖ®Â±ÄÂàùÂßãÂåñ"></a>2) ÈùôÊÄÅÂàùÂßãÂåñ Âíå ÂÖ®Â±ÄÂàùÂßãÂåñ</h3><p><strong>ÂÖ®Â±Ä</strong>Âíå<strong>ÈùôÊÄÅ</strong>ÁöÑÂØπË±°‰ºöÂú® <code>main()</code> ÂáΩÊï∞ÂâçÈù¢ÂàùÂßãÂåñ„ÄÇÂú® MSVC++ ‰∏≠ÔºåÁºñËØëÂô®‰ºö‰∏∫<strong>ÂÖ®Â±Ä</strong>Âíå<strong>ÈùôÊÄÅ</strong>ÂáΩÊï∞ÁîüÊàêÁõ∏Â∫îÁöÑ<strong>ÂàùÂßãÂåñÂô®</strong>ÔºåÂπ∂Êää‰ªñ‰ª¨ÁöÑÂú∞ÂùÄÊîæÂú®‰∏Ä‰∏™<strong>Ë°®</strong>Ôºà<code>table</code>Ôºâ‰∏≠ÔºåËøô‰∏™<strong>Ë°®</strong>‰ºöÂú® <code>_cinit()</code> ÂàùÂßãÂåñ <strong>CRT</strong> ÁöÑÊó∂ÂÄôÁîüÊàê„ÄÇÂú® <strong>PE</strong> ÁªìÊûÑ‰∏≠ÔºåËøô‰∏™<strong>Ë°®</strong>ÈÄöÂ∏∏Âú® <code>.data</code> ÊÆµÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇÂÖ∏ÂûãÁöÑÂàùÂßãÂåñÂô®ÁªìÊûÑÁ§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">_init_gA1:</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, offset _gA1</div><div class="line">    <span class="keyword">call</span>    A::A()</div><div class="line">    <span class="keyword">push</span>    offset _term_gA1</div><div class="line">    <span class="keyword">call</span>    _atexit</div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">retn</span></div><div class="line"><span class="symbol">_term_gA1:</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, offset _gA1</div><div class="line">    <span class="keyword">call</span>    A::~A()</div><div class="line">    <span class="keyword">retn</span></div></pre></td></tr></table></figure>
<p>ËøôÊ†∑Ôºå‰ªé‰∏äÈù¢Ëøô‰∏™Ë°®ÈáåÊàë‰ª¨ÂèØ‰ª•ÁúãÂá∫Ôºö</p>
<ul>
<li><strong>ÂÖ®Â±Ä</strong>/<strong>ÈùôÊÄÅ</strong>ÂØπË±°ÁöÑÂú∞ÂùÄÔºõ</li>
<li>ÂÆÉ‰ª¨ÁöÑ<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong></li>
<li>ÂÆÉ‰ª¨ÁöÑ<strong>ÊûêÊûÑÂáΩÊï∞</strong></li>
</ul>
<p>Êõ¥Â§öÁªÜËäÇÂèØ‰ª•ÂèÇËÄÉ <code>_#pragma_directive_init_seg_</code> [5]„ÄÇ</p>
<h3 id="3-Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind-FuncletsÔºâ"><a href="#3-Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind-FuncletsÔºâ" class="headerlink" title="3) Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind FuncletsÔºâ"></a>3) Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind FuncletsÔºâ</h3><p>‰∏Ä‰∏™ÂáΩÊï∞‰∏≠ÁîüÊàê‰ªª‰Ωï<strong>Âä®ÊÄÅ</strong>ÁöÑÂØπË±°Êó∂ÔºåVC++ ÁºñËØëÂô®ÊÄª‰ºöÁîüÊàê‰∏Ä‰∏™Áõ∏ÂÖ≥ÁöÑÂºÇÂ∏∏Â§ÑÁêÜÁªìÊûÑÔºå‰ª•‰æøÂú®ÈÅáÂà∞ÂºÇÂ∏∏Êó∂ËøõË°åÊ†àÂ±ïÂºÄ„ÄÅÈîÄÊØÅËØ•Âä®ÊÄÅÂØπË±°„ÄÇVC++ ‰∏≠ÂºÇÂ∏∏Â§ÑÁêÜÁöÑÂ∫ïÂ±ÇÁªÜËäÇÂèØ‰ª•ÂèÇËÄÉÊú¨Á≥ªÂàóÂâç‰∏ÄÁØá„ÄÇÂÖ∏ÂûãÁöÑ <code>Unwind Funclets</code> ÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">unwind_1tobase:</span>  <span class="comment">; state 1 -&gt; -1</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line">    <span class="keyword">jmp</span>     A::~A()</div></pre></td></tr></table></figure>
<p>ÈÄöËøáÂú®ÂáΩÊï∞‰Ωì‰∏≠ÂØªÊâæÁõ∏ÂèçÁöÑÁä∂ÊÄÅÂèòÂåñÔºåÊàñËÄÖÂú®Á¨¨‰∏ÄÊ¨°ËÆøÈóÆÊ†à‰∏≠ÁöÑÂêå‰∏Ä‰∏™ÂèòÈáèÔºåÊàë‰ª¨‰πüÂèØ‰ª•ÊâæÂà∞ÂÖ∂<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>Ôºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+a1]</div><div class="line"><span class="keyword">call</span>    A::A()</div><div class="line"><span class="keyword">mov</span>     [<span class="built_in">ebp</span>+__$EHRec$.state], <span class="number">1</span></div></pre></td></tr></table></figure>
<p>ÂØπ‰∏éÈÇ£‰∫õÁî® <code>new()</code> ÊñπÊ≥ïÂàõÂª∫ÁöÑÂØπË±°Ôºå<strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong> ‰øùËØÅÂç≥‰ΩøÂú®ÊûêÊûÑÂáΩÊï∞Â§±ÊïàÁöÑÊÉÖÂÜµ‰∏ãÔºå‰πüËÉΩÂà†Èô§ÊéâÂàÜÈÖçÁªôËøô‰∫õÂØπË±°ÁöÑÂÜÖÂ≠òÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">unwind_0tobase:</span> <span class="comment">; state 0 -&gt; -1</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+pA1]</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">eax</span></div><div class="line">    <span class="keyword">call</span>    operator delete(void *)</div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">retn</span></div></pre></td></tr></table></figure>
<p>Âú®ÂáΩÊï∞‰Ωì‰∏≠Ôºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;A* pA1 = new A();</span></div><div class="line">    <span class="keyword">push</span></div><div class="line">    <span class="keyword">call</span>    operator new(uint)</div><div class="line">    <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">4</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+pA1], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+__$EHRec$.state], <span class="number">0</span><span class="comment">; state 0: memory allocated but object is not yet constructed</span></div><div class="line">    <span class="keyword">jz</span>      short @@new_failed</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">call</span>    A::A()</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">jmp</span>     short @@constructed_ok</div><div class="line"></div><div class="line">@@new_failed:</div><div class="line">    <span class="keyword">xor</span>     <span class="built_in">esi</span>, <span class="built_in">esi</span></div><div class="line"></div><div class="line">@@constructed_ok:</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">esp</span>+<span class="number">14h</span>+__$EHRec$.state], -<span class="number">1</span></div><div class="line"><span class="comment">;state -1: either object was constructed successfully or memory allocation failed</span></div><div class="line"><span class="comment">;in both cases further memory management is done by the programmer</span></div></pre></td></tr></table></figure>
<p>Âè¶‰∏ÄÁßçÂΩ¢ÂºèÁöÑ <strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong> Â≠òÂú®‰∫é<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong> Âíå <strong>ÊûêÊûÑÂáΩÊï∞</strong> ‰∏≠ÔºåÂÆÉÂ∞Ü‰øùËØÅÂú®Á®ãÂ∫èÈÅáÂà∞ÂºÇÂ∏∏Êó∂ÈîÄÊØÅÂØπË±°ÊàêÂëò„ÄÇËøôÁßçÊÉÖÂÜµ‰∏ãÁöÑ <strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong> ‰ΩøÁî®ÁöÑÊòØ‰øùÂ≠òÂú®Ê†àÂèòÈáè‰∏≠ÁöÑ <code>_this_</code> ÊåáÈíàÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">unwind_2to1:</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+_this] <span class="comment">; state 2 -&gt; 1</span></div><div class="line">    <span class="keyword">add</span>     <span class="built_in">ecx</span>, <span class="number">4Ch</span></div><div class="line">    <span class="keyword">jmp</span>     B1::~B1</div></pre></td></tr></table></figure>
<p>‰∏äÈù¢Ëøô‰∏™‰æãÂ≠ê‰∏≠Ôºå<strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong> ÈîÄÊØÅ‰∫Ü <code>B1</code> Âú®ÂÅèÁßª <code>0x4c</code> Â§ÑÁöÑÊàêÂëò„ÄÇÊÄªÁöÑÊù•ËØ¥ÔºåÈÄöËøá <strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong>ÔºåÊàë‰ª¨ÂèØ‰ª•Ëé∑Âèñ‰∏Ä‰∏ã‰ø°ÊÅØÔºö</p>
<ul>
<li>Ê†à‰∏≠‰øùÂ≠òÁöÑÈÄöËøá <code>_operator_new_</code> ÂàõÂª∫ÁöÑ C++ ÂØπË±°ÔºåÊàñÊåáÂêëÂØπË±°ÁöÑÊåáÈíàÔºõ</li>
<li>Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºõ</li>
<li>Á±ªÁöÑÊûêÊûÑÂáΩÊï∞Ôºõ</li>
<li><code>new()</code> ÂàõÂª∫Âá∫Êù•ÁöÑÂØπË±°ÁöÑ <code>size</code>„ÄÇ</li>
</ul>
<h3 id="4-ÈÄíÂΩíÊûÑÈÄ†-ÊûêÊûÑÂáΩÊï∞"><a href="#4-ÈÄíÂΩíÊûÑÈÄ†-ÊûêÊûÑÂáΩÊï∞" class="headerlink" title="4) ÈÄíÂΩíÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞"></a>4) ÈÄíÂΩíÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞</h3><p>Ëøô‰∏™ËßÑÂàôÂæàÁÆÄÂçïÔºö<strong>ÈÄíÂΩíÊûÑÈÄ†ÂáΩÊï∞</strong>ÈÄíÂΩíÂú∞Ë∞ÉÁî®ÂÖ∂‰ªñÊûÑÈÄ†ÂáΩÊï∞ÔºàÊØîÂ¶ÇÂü∫Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞„ÄÅÂÖ∂‰ªñÊàêÂëòÁöÑÊûÑÈÄ†ÂáΩÊï∞ÔºâÔºõ<strong>ÈÄíÂΩíÊûêÊûÑÂáΩÊï∞</strong> ÈÄíÂΩíÂú∞Ë∞ÉÁî®‰ªñ‰ª¨ÊâÄÊúâÁöÑÊûêÊûÑÂáΩÊï∞„ÄÇÂÖ∏ÂûãÁöÑ<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>ÂÖ∑Êúâ‰ª•‰∏ãÂäüËÉΩÔºö</p>
<ul>
<li>Ë∞ÉÁî®Âü∫Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºõ</li>
<li>Ë∞ÉÁî®ÂÖ∂‰ªñÂµåÂ•óÂØπË±°ÊâÄÂ±ûÁ±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºõ</li>
<li>Â¶ÇÊûúÁ±ª‰∏≠Â£∞Êòé‰∫Ü<strong>ËôöÂáΩÊï∞</strong>ÔºåÂàôÂàùÂßãÂåñ<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ôºà <code>vfptr</code> ÔºâÔºõ</li>
<li>ÊâßË°åÁ®ãÂ∫èÂëòÂÆö‰πâÁöÑ<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>ÂáΩÊï∞‰Ωì„ÄÇ</li>
</ul>
<p>ÂÖ∏ÂûãÁöÑ<strong>ÊûêÊûÑÂáΩÊï∞</strong>ÂàôÂÖ∑ÊúâÁõ∏ÂØπÂ∫îÁöÑ‰ª•‰∏ãÂäüËÉΩÔºö</p>
<ul>
<li>Â¶ÇÊûúÁ±ª‰∏≠Â£∞Êòé‰∫Ü<strong>ËôöÂáΩÊï∞</strong>ÔºåÂàôÂàùÂßãÂåñ<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ôºà <code>vfptr</code> ÔºâÔºõ</li>
<li>ÊâßË°åÁ®ãÂ∫èÂëòÂÆö‰πâÁöÑ<strong>ÊûêÊûÑÂáΩÊï∞</strong>ÂáΩÊï∞‰ΩìÔºõ</li>
<li>Ë∞ÉÁî®ÂÖ∂‰ªñÂµåÂ•óÂØπË±°ÊâÄÂ±ûÁ±ªÁöÑÊûêÊûÑÂáΩÊï∞</li>
<li>Ë∞ÉÁî®Âü∫Á±ªÁöÑÊûêÊûÑÂáΩÊï∞„ÄÇ</li>
</ul>
<p>‰∏çËøáÔºå MSVC ÁºñËØëÂô®ÂàõÂª∫ÁöÑ <strong>ÊûêÊûÑÂáΩÊï∞</strong> ËøòÊúâ‰∏Ä‰∏™ÁâπÊÄßÔºö<code>_state_</code> ‰ª•<strong>ÊúÄÂ§ßÂÄº</strong>ÂàùÂßãÂåñÔºåÂπ∂ÈöèÁùÄÂØπÊàêÂëòÂØπË±°ÁöÑÊûêÊûÑË°å‰∏∫ËÄåÈÄíÂáè„ÄÇËøôÊ†∑‰∏ÄÊù•ÂèçËÄåÊñπ‰æøÂàÜÊûêÊûêÊûÑÂáΩÊï∞ÁöÑÊâßË°å„ÄÇÂè¶Â§ñÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÂú® MSVC ‰∏≠ÔºåÁÆÄÂçïÁöÑ ÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞ÈÄöÂ∏∏ÊòØ‰ª•ÂÜÖËÅîÂΩ¢ÂºèÂ≠òÂú®ÁöÑÔºåÊâÄ‰ª•ÁªèÂ∏∏‰ºöÂú®Âêå‰∏Ä‰∏™ÂáΩÊï∞‰∏≠ÁúãÂà∞<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ë¢´‰∏çÂêåÊåáÈíàÈáçÂ§çË∞ÉÁî®„ÄÇ</p>
<h3 id="5-Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ"><a href="#5-Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ" class="headerlink" title="5) Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ"></a>5) Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ</h3><p>MSVC Áî®ËæÖÂä©ÂáΩÊï∞Êù•ÂÆåÊàê‰∏Ä‰∏™ÂØπË±°Êï∞ÁªÑÁöÑÊûÑÈÄ†‰∏éÊûêÊûÑ„ÄÇÁî®‰ª•‰∏ã‰ª£Á†Å‰∏∫‰æãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">A* pA = <span class="keyword">new</span> A[n];</div><div class="line"><span class="keyword">delete</span> [] pA;</div></pre></td></tr></table></figure>
<p>Áî® C++ ‰º™Á†ÅËØ¶ÁªÜËøòÂéü‰∏Ä‰∏ãÔºåÂ§ßÊ¶ÇÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">array = new char(sizeof(A)*n+sizeof(int))</div><div class="line">if (array)</div><div class="line">&#123;</div><div class="line">  *(int*)array=n; //store array size in the beginning</div><div class="line">  'eh vector constructor iterator'(array+sizeof(int),sizeof(A),count,&amp;A::A,&amp;A::~A);</div><div class="line">&#125;</div><div class="line">pA = array;</div><div class="line"></div><div class="line">'eh vector destructor iterator'(pA,sizeof(A),count,&amp;A::~A);</div></pre></td></tr></table></figure>
<p>Â¶ÇÊûú <code>A</code> ÂåÖÂê´ËôöÂáΩÊï∞ÔºåÂà†Èô§ÂØπË±°Êï∞ÁªÑÁöÑÊó∂ÂÄô‰ºöË∞ÉÁî®‰∏Ä‰∏™ <code>vector deleting destructor</code> Ôºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;pA-&gt;'vector deleting destructor'(3);</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, pA</div><div class="line"><span class="keyword">push</span> <span class="number">3</span> <span class="comment">; flags: 0x2=deleting an array, 0x1=free the memory</span></div><div class="line"><span class="keyword">call</span> A::<span class="string">'vector deleting destructor'</span></div></pre></td></tr></table></figure>
<p>Â¶ÇÊûú <code>A</code> ÁöÑ<strong>ÊûêÊûÑÂáΩÊï∞</strong>ÊòØ‰∏™<strong>ËôöÂáΩÊï∞</strong>ÔºåÈÇ£‰πàÊûêÊûÑÁöÑÊó∂ÂÄô‰ºö‰ª•Ë∞ÉÁî®ËôöÂáΩÊï∞ÁöÑÊñπÂºèË∞ÉÁî®ÊûêÊûÑÂáΩÊï∞Ôºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, pA</div><div class="line"><span class="keyword">push</span> <span class="number">3</span></div><div class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ecx</span>] <span class="comment">;fetch vtable pointer</span></div><div class="line"><span class="keyword">call</span> [<span class="built_in">eax</span>]     <span class="comment">;call deleting destructor</span></div></pre></td></tr></table></figure>
<p>Âõ†Ê≠§ÔºåÈÄöÂ∏∏Êù•ËØ¥ÈÄöËøáÊûÑÈÄ†/ÊûêÊûÑÁöÑÊï∞ÁªÑËø≠‰ª£Ë∞ÉÁî®ÔºåÊàë‰ª¨ÂèØ‰ª•ÂèëÊéò‰ª•‰∏ã‰ø°ÊÅØÔºö</p>
<ul>
<li>ÂØπË±°Êï∞ÁªÑÁöÑÂú∞ÂùÄÔºõ</li>
<li>Êï∞ÁªÑÈáåÂêÑÂØπË±°ÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºõ</li>
<li>Êï∞ÁªÑÈáåÂêÑÂØπË±°ÁöÑÊûêÊûÑÂáΩÊï∞Ôºõ</li>
<li>Á±ªÁöÑ <code>size</code>„ÄÇ</li>
</ul>
<h3 id="6-Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà-deleting-destructor-Ôºâ"><a href="#6-Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà-deleting-destructor-Ôºâ" class="headerlink" title="6) Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà deleting destructor Ôºâ"></a>6) Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà <code>deleting destructor</code> Ôºâ</h3><p>ÂΩìÁ±ª‰∏≠Âê´Êúâ<strong>ËôöÊûêÊûÑÂáΩÊï∞</strong>Ôºà <code>virtual destructor</code> ÔºâÊó∂ÔºåÁºñËØëÂô®‰ºöÁîüÊàê‰∏Ä‰∏™ËæÖÂä©ÂáΩÊï∞‚Äî‚Äî<strong>Âà†Èô§ÊûêÊûÑÂáΩÊï∞</strong>ÔºåËøôÊ†∑‰æøËÉΩÁ°Æ‰øùÈîÄÊØÅ‰∏Ä‰∏™Á±ªÂÆû‰æãÁöÑÊó∂ÂÄôÂêàÈÄÇÁöÑ <code>_operator delete_</code> Ë¢´Ë∞ÉÁî®„ÄÇ<strong>Âà†Èô§ÊûêÊûÑÂáΩÊï∞</strong> ÁöÑ‰º™Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">virtual void * A::'scalar deleting destructor'(uint flags)</div><div class="line">&#123;</div><div class="line">  this-&gt;~A();</div><div class="line">  if (flags&amp;1) A::operator delete(this);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ËØ•ÂáΩÊï∞ÁöÑÂú∞ÂùÄ‰ºöË¢´ÊîæÂú®<strong>ËôöÂáΩÊï∞Ë°®</strong>( <code>vftable</code>) ‰∏≠ÔºåÂπ∂Ë¶ÜÁõñÂéüÊúâÁöÑÊûêÊûÑÂáΩÊï∞Âú∞ÂùÄ„ÄÇËøôÊ†∑‰∏ÄÊù•ÔºåÂ¶ÇÊûúÂè¶Â§ñ‰∏Ä‰∏™Á±ªË¶ÜÁõñ‰∫ÜËøô‰∏™ËôöÊûêÊûÑÂáΩÊï∞ÔºåÈÇ£‰πàÂÆÉÁöÑ <code>_delete_</code> Â∞ÜË¢´Ë∞ÉÁî®„ÄÇÁÑ∂ËÄåÂÆûÈôÖ‰ª£Á†Å‰∏≠ <code>_delete_</code> Âá†‰πé‰∏ç‰ºöË¢´Ë¶ÜÁõñÔºåÊâÄ‰ª•‰Ω†ÈÄöÂ∏∏Âè™ÁúãÂà∞Ë∞ÉÁî®ÈªòËÆ§ÁöÑdelete()„ÄÇÊúâÊó∂ÂÄôÔºåÁºñËØëÂô®‰πüÁîüÊàê‰∏Ä‰∏™Âà†Èô§ÊûêÊûÑÂáΩÊï∞ÂêëÈáèÔºå‰º™Á†ÅÁ§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">virtual void * A::'vector deleting destructor'(uint flags)</div><div class="line">&#123;</div><div class="line">  if (flags&amp;2) //Âà†Èô§‰∏Ä‰∏™Êï∞ÁªÑÔºàdestructing a vectorÔºâ</div><div class="line">  &#123;</div><div class="line">    array = ((int*)this)-1; //Êï∞ÁªÑÂ§ßÂ∞èÂ≠ò‰∫éÊ≠§ÊåáÈíàÂâçÈù¢Ôºàarray size is stored just before the this pointerÔºâ</div><div class="line">    count = array[0];</div><div class="line">    'eh vector destructor iterator'(this,sizeof(A),count,A::~A);</div><div class="line">    if (flags&amp;1) A::operator delete(array);</div><div class="line">  &#125;</div><div class="line">  else &#123;</div><div class="line">    this-&gt;~A();</div><div class="line">    if (flags&amp;1) A::operator delete(this);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ÊàëÂøΩÁï•‰∫ÜÂ§ßÈÉ®ÂàÜÊ∂âÂèäËôöÂü∫Á±ªÁöÑÁ±ªÁöÑÂÆûÁé∞ÁªÜËäÇÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÊòØÂú®Â§™Â§çÊùÇÔºåËÄå‰∏îÂú®Áé∞ÂÆûÁîüÊ¥ª‰∏≠ÂæàÂ∞ëÁî®Âà∞„ÄÇËØ∑ÂèÇËÄÉ Jan Gray ÁöÑÊñáÁ´†[1]ÔºåÂÆÉÈùûÂ∏∏Áõ∏ËøëÔºàËØ∑ÂøΩÁï•ÈÇ£ÁúãÁùÄËÑë‰ªÅÁñºÁöÑÂåàÁâôÂà©ÂëΩÂêçÊ≥ïÔºâ„ÄÇÊñáÁ´†[2]ÊèèËø∞‰∫Ü‰∏Ä‰∏™MSVCÂÆûÁé∞ËôöÁªßÊâøÁöÑÂÆûÁé∞„ÄÇÊõ¥Â§öÁªÜËäÇËøòÂèØ‰ª•Áúã MS ‰∏ìÂà©[3]„ÄÇ</p>
<h2 id="ÈôÑÂΩï-1Ôºö-ms-rtti4-idc"><a href="#ÈôÑÂΩï-1Ôºö-ms-rtti4-idc" class="headerlink" title="ÈôÑÂΩï 1Ôºö ms_rtti4.idc"></a>ÈôÑÂΩï 1Ôºö <code>ms_rtti4.idc</code></h2><p>ËøôÊòØÊàë‰∏∫Ëß£Êûê <strong>RTTI</strong> Âíå<strong>ËôöÂáΩÊï∞Ë°®</strong>ÂÜôÁöÑ‰∏Ä‰∏™ IDA ËÑöÊú¨ÔºåËØªËÄÖÂèØ‰ª•‰ªé <a href="http://www.openrce.org/downloads/details/196" target="_blank" rel="external"> Microsoft VC++ Reversing Helpers</a> ‰∏ãËΩΩÂà∞ËØ•ËÑöÊú¨‰ª•ÂèäÊú¨Á≥ªÂàó‰∏§ÁØáÊñáÁ´†„ÄÇËØ•ËÑöÊú¨ÁöÑÂäüËÉΩÁâπÊÄßÊúâ‰ª•‰∏ãÂá†‰∏™Ôºö</p>
<ul>
<li>Ëß£Êûê <strong>RTTI</strong> ÁªìÊûÑ„ÄÅÁî®Áõ∏Â∫îÁöÑÁ±ªÂêçÈáçÂëΩÂêç<strong>ËôöÂáΩÊï∞Ë°®</strong>Ôºõ</li>
<li>Âú®Áõ∏ÂØπÁÆÄÂçïÁöÑÂàÜÊûêÂ∑•‰Ωú‰∏≠ÈáçÂëΩÂêç<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>‰∏é<strong>ÊûêÊûÑÂáΩÊï∞</strong>Ôºõ</li>
<li>ÊääÊâÄÊúâÁöÑ<strong>ËôöÂáΩÊï∞Ë°®</strong>‰ª•Âèä<strong>ÂºïÁî®ÂáΩÊï∞</strong>ÂíåÁ±ªÁöÑÁªßÊâøÂÖ≥Á≥ªËæìÂá∫Âà∞Êñá‰ª∂‰∏≠„ÄÇ</li>
</ul>
<blockquote>
<p><strong>Usage</strong>Ôºö<br>IDA ÁöÑÂàùÂßãÂåñÂàÜÊûêÁªìÊùü‰πãÂêéÔºåËΩΩÂÖ• <code>ms_rtti4.idc</code> ÔºåÂÆÉ‰ºöËØ¢ÈóÆ‰Ω†ÊòØÂê¶Ë¶ÅÊâ´Êèè PE Êñá‰ª∂‰∏≠ÁöÑ<strong>ËôöÂáΩÊï∞Ë°®</strong>Ôºàvftables)„ÄÇÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåËøô‰∏™ËøáÁ®ãÂèØËÉΩÈúÄË¶ÅÊØîËæÉÈïøÁöÑÊó∂Èó¥„ÄÇÂ¶ÇÊûú‰Ω†ÈÄâÊã©Ë∑≥ËøáÊâ´ÊèèÔºåÂêéÁª≠‰ªçÁÑ∂ÂèØ‰ª•ÊâãÂä®Ëß£Êûê<strong>ËôöÂáΩÊï∞Ë°®</strong>„ÄÇÂ¶ÇÊûú‰Ω†ÈÄâÊã©ËÆ©ËÑöÊú¨Â∏Æ‰Ω†ÊâßË°åÊâ´ÊèèÔºåËÑöÊú¨‰ºöËØÜÂà´ PE Êñá‰ª∂‰∏≠ÊâÄÊúâ‰ΩøÁî® <strong>RTTI</strong> ÁöÑ<strong>ËôöÂáΩÊï∞Ë°®</strong>ÔºåÂπ∂‰∏î‰ºöÈáçÂëΩÂêç<strong>ËôöÂáΩÊï∞Ë°®</strong>„ÄÅËØÜÂà´ÂíåÈáçÂëΩÂêçÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞„ÄÇ‰πüÊúâÂèØËÉΩËÑöÊú¨‰ºöËß£ÊûêÂ§±Ë¥•ÔºåÂ∞§ÂÖ∂ÊòØÊ∂âÂèäÂà∞<strong>ËôöÁªßÊâø</strong>ÁöÑÊÉÖÂÜµ„ÄÇÊâ´ÊèèÁªìÊùüÂêéÔºåËÑöÊú¨‰ºöËá™Âä®ÊâìÂºÄÂ≠òÊîæÊâ´ÊèèÁªìÊûúÁöÑÊñá‰ª∂„ÄÇ</p>
</blockquote>
<p>Âè¶Â§ñÔºåËÑöÊú¨ËΩΩÂÖ•‰ª•ÂêéÔºåÂèØ‰ª•‰ΩøÁî®‰ª•‰∏ã <strong>Âø´Êç∑ÈîÆ</strong> Êù•ÂØπ MSVC ÁîüÊàêÁöÑÁªìÊûÑËøõË°åÊâãÂä®Ëß£ÊûêÔºö</p>
<ul>
<li><strong><code>Alt+F8</code></strong>ÔºöËß£Êûê‰∏Ä‰∏™<strong>ËôöÂáΩÊï∞Ë°®„ÄÇÊ∏∏Ê†áÂ∫îËØ•‰ºöÂÅúÂú®ËôöÂáΩÊï∞Ë°®ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇÂ¶ÇÊûúÈáåÈù¢Áî®Âà∞‰∫Ü </strong>RTTI<strong>ÔºåËÑöÊú¨‰ºö‰ΩøÁî®ÈáåÈù¢ÁöÑÁ±ªÂêçÊù•ÈáçÂëΩÂêçËôöÂáΩÊï∞Ë°®„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊ∂âÂèäÂà∞ </strong>RTTI<strong>Ôºå‰Ω†ÂèØ‰ª•ÊâãÂä®ËæìÂÖ•Á±ªÂêçÊù•Ëá™ÂÆö‰πâ„ÄÇÂ¶ÇÊûúËÑöÊú¨Êâ´ÊèèÂà∞‰∫Ü</strong>ËôöÊûêÊûÑÂáΩÊï∞**Ôºå‰∏ÄÊ†∑‰πü‰ºöÊääÂÆÉÈáçÂëΩÂêç„ÄÇ</li>
<li><p><strong><code>Alt+F7</code></strong>ÔºöËß£Êûê <code>FuncInfo</code> ÁªìÊûÑ„ÄÇ<code>FuncInfo</code> ÊòØ‰∏Ä‰∏™ÊèèËø∞Âú®Ê†à‰∏äÂàõÂª∫ÂØπË±°Êàñ‰ΩøÁî®ÂºÇÂ∏∏Â§ÑÁêÜÂè•ÊüÑÁöÑÂáΩÊï∞‰ø°ÊÅØÁöÑÁªìÊûÑ„ÄÇÂÆÉÁöÑÂú∞ÂùÄÂú®ÂºÇÂ∏∏Â§ÑÁêÜÂè•ÊüÑ‰∏≠ÈÄöÂ∏∏Ë¢´Ëß£Êûê‰∏∫ <code>_CxxFrameHandler</code> Ôºö</p>
  <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>, offset FuncInfo1</div><div class="line"><span class="keyword">jmp</span> _CxxFrameHandler</div></pre></td></tr></table></figure>
<p>  Â§öÊï∞ÊÉÖÂÜµ‰∏ãÂÆÉ‰ºöË¢´ IDA Áõ¥Êé•ËØÜÂà´Âπ∂Ëß£ÊûêÔºå‰ΩÜÊòØÊàëÊèê‰æõÁöÑËÑöÊú¨ÂèØ‰ª•Ëß£ÊûêÂá∫Êõ¥Â§öÁöÑ‰ø°ÊÅØÔºå‰Ω†ÂèØ‰ª•Áî® <code>ms_ehseh.idc</code> Ëß£ÊûêÊñá‰ª∂‰∏≠ÁöÑÊâÄÊúâ <code>FuncInfo</code> „ÄÇ<br>  Ê∏∏Ê†áÊîæÂà∞ <code>FuncInfo</code> Ëµ∑Âßã‰ΩçÁΩÆÁöÑÔºåÊ≠§Âø´Êç∑ÈîÆÊúâÊïà„ÄÇ</p>
</li>
<li><p><strong><code>Alt+F9</code></strong>ÔºöËß£Êûê <code>throw</code> ‰ø°ÊÅØ„ÄÇ<code>Throw info</code> ÊòØ <code>_CxxThrowException</code> Âú®ÂÆûÁé∞ <code>_throw</code> Êìç‰ΩúÁ¨¶Êó∂Áî®Âà∞ÁöÑËæÖÂä©ÁªìÊûÑÔºåÂÆÉÈÄöÂ∏∏‰Ωú‰∏∫ <code>_CxxThrowException</code> ÁöÑÁ¨¨‰∫å‰∏™ÂèÇÊï∞Ë¢´Ë∞ÉÁî®Ôºö</p>
  <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+e]</div><div class="line"><span class="keyword">call</span>    E::E()</div><div class="line"><span class="keyword">push</span>    offset ThrowInfo_E</div><div class="line"><span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+e]</div><div class="line"><span class="keyword">push</span>    <span class="built_in">eax</span></div><div class="line"><span class="keyword">call</span>    _CxxThrowException</div></pre></td></tr></table></figure>
<p>  Ê∏∏Ê†áÊîæÂú® <code>throw info</code> Ëµ∑Âßã‰ΩçÁΩÆÁöÑÊó∂ÂÄôÊ¨°Âø´Êç∑ÈîÆÊâçÊúâÊïà„ÄÇËØ•ËÑöÊú¨‰ºöËß£Êûê <code>throw info</code> Âπ∂‰∏∫Ë∞ÉÁî® <code>throw</code> Êìç‰ΩúÁ¨¶ÁöÑÁ±ªÊ∑ªÂä†Ê≥®Èáä„ÄÇÂÆÉËøòÂèØ‰ª•ËØÜÂà´ÂíåÈáçÂëΩÂêçÂºÇÂ∏∏ÁöÑÊûêÊûÑÂáΩÊï∞ÂíåÊã∑Ë¥ùÊûÑÈÄ†ÂáΩÊï∞„ÄÇ</p>
</li>
</ul>
<h2 id="ÈôÑÂΩï-2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ"><a href="#ÈôÑÂΩï-2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ" class="headerlink" title="ÈôÑÂΩï 2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ"></a>ÈôÑÂΩï 2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ</h2><p>Êàë‰ª¨ÁªÉÊâãÁöÑÂØπË±°ÊòØ <code>MSN Messenger 7.5</code> Ôºà <code>msnmsgr.exe</code>  ÁâàÊú¨ÊòØ <code>7.5.324.0</code> , Â§ßÂ∞è 7094272 Bytes ÔºâÔºåÂÆÉ‰∏ªË¶ÅÁî± C++ ÂÆûÁé∞ÔºåÂπ∂‰∏îÈáåÈù¢Áî®Âà∞‰∫ÜÂæàÂ§ö <strong>RTTI</strong> ÁöÑÁªìÊûÑÔºåÊ≠£Á¨¶ÂêàÊàë‰ª¨ÁöÑÈúÄÊ±Ç„ÄÇÂÖàÁúã‰∏Ä‰∏ã‰Ωç‰∫é <code>.0040EFD8</code> Âíå <code>.0040EFE0</code> ÁöÑ‰∏§Â§Ñ<strong>ËôöÂáΩÊï∞Ë°®</strong>„ÄÇÂÖ∂‰∏≠ÂÆåÊï¥ÁöÑ RTTI ÁªìÊûÑÂèäÂÖ∂ÁªßÊâøÂÖ≥Á≥ªÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö<br><img src="/imgs/14938199737802.jpg" alt="RTTI hierarchy for MSN Messenger 7.5"></p>
<p>ËøôÊ†∑‰∏ÄÊù•ÔºåÂ∞±Êúâ‰∫Ü‰∏§‰∏™<strong>ËôöÂáΩÊï∞Ë°®</strong>Â±û‰∫éÂêå‰∏Ä‰∏™<strong>Á±ª</strong> ‚Äî‚Äî <code>CContentMenuItem</code> ÔºåÂÜçÁúãÂÆÉ‰ª¨ÁöÑ<strong>Âü∫Á±ªÊèèËø∞Á¨¶</strong>Êàë‰ª¨ÂèØ‰ª•ÂèëÁé∞Ôºö</p>
<ul>
<li><code>CContentMenuItem</code> ÈáåÈù¢ÂåÖÂê´ 3 ‰∏™<strong>Âü∫Á±ª</strong> ‚Äî‚Äî <code>CDownloader</code>/<code>CNativeEventSink</code>/<code>CNativeEventSource</code>;</li>
<li><code>CDownloader</code> ÂåÖÂê´ 1 ‰∏™<strong>Âü∫Á±ª</strong> ‚Äî‚Äî <code>CNativeEventSink</code>Ôºõ</li>
<li>Âõ†Ê≠§ <code>CContentMenuItem</code> ÁªßÊâøËá™ <code>CDownloader</code> Âíå <code>CNativeEventSource</code>ÔºåËÄå <code>CDownloader</code> ÁªßÊâøËá™ <code>CNativeEventSink</code>Ôºõ</li>
<li><code>CDownloader</code> ‰Ωç‰∫éÊï¥‰∏™ÂØπË±°ÁöÑËµ∑Âßã‰ΩçÁΩÆÔºå<code>CNativeEventSource</code> Âàô‰Ωç‰∫éÂÅèÁßª‰∏∫ <code>0x24</code> ÁöÑ‰ΩçÁΩÆ„ÄÇ</li>
</ul>
<p><img src="/imgs/14938205753585.jpg" alt=""></p>
<p>ÊçÆÊ≠§ÔºåÊàë‰ª¨ÂèØ‰ª•ÂæóÂá∫Ëøô‰πà‰∏Ä‰∏™ÁªìËÆ∫ÔºöÁ¨¨‰∏Ä‰∏™<strong>ËôöÂáΩÊï∞Ë°®</strong>ÂàóÂá∫‰∫Ü <code>CNativeEventSource</code> ÈáåÁöÑÊñπÊ≥ïÔºåÁ¨¨‰∫å‰∏™<strong>ËôöÂáΩÊï∞Ë°®</strong>ÂàóÂá∫‰∫Ü <code>CDownloader</code> ÊàñËÄÖ <code>CNativeEventSink</code> ÈáåÁöÑÊñπÊ≥ïÔºàÂ¶ÇÊûúËøô‰∏§ËÄÖÈÉΩ‰∏çÊòØÔºå<code>CContentMenuItem</code> ‰ºöÈáçÁî® <code>CNativeEventSource</code> ÁöÑ<strong>ËôöÂáΩÊï∞Ë°®</strong>Ôºâ„ÄÇÊàë‰ª¨ÂÜçÊù•ÁúãÈÉΩÊúâË∞ÅÂºïÁî®‰∫ÜËøô‰∏§‰∏™<strong>ËôöÂáΩÊï∞Ë°®</strong>ÔºåÂÆÉ‰ª¨<strong>ÈÉΩ</strong>Ë¢´‰Ωç‰∫é <code>.052B5E0</code> Âíå <code>.052B547</code> ÁöÑ‰∏§‰∏™ÂáΩÊï∞ÂºïÁî®ÔºàËøôÊ†∑Ëøõ‰∏ÄÊ≠•Âç∞ËØÅ‰∫ÜÂÆÉ‰ª¨Â±û‰∫éÂêå‰∏Ä‰∏™<strong>Á±ª</strong>Ôºâ„ÄÇÂ¶ÇÊûúÊàë‰ª¨‰ªîÁªÜÊü•Áúã <code>.052B547</code> Â§ÑÂáΩÊï∞ÁöÑÂºÄÂ§¥ÔºåÂèØ‰ª•ÂèëÁé∞ <code>_state_</code> Ë¢´ÂàùÂßãÂåñ‰∏∫ <code>6</code>ÔºåËøôË°®ÊòéËØ•ÂáΩÊï∞ÊòØ‰∏Ä‰∏™ <strong>ÊûêÊûÑÂáΩÊï∞</strong>ÔºõÁî±‰∫é‰∏Ä‰∏™Á±ªÂè™ËÉΩÊúâ 1 ‰∏™ÊûêÊûÑÂáΩÊï∞ÔºåÊàë‰ª¨ÂèØ‰ª•Êé®Êñ≠ <code>.052B5E0</code> Â§ÑÁöÑÂáΩÊï∞ÊòØ‰∏Ä‰∏™<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>Ôºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">CContentMenuItem:</span>:CContentMenuItem   proc <span class="built_in">near</span></div><div class="line">this = <span class="built_in">esi</span></div><div class="line">    <span class="keyword">push</span>    this</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edi</span></div><div class="line">    <span class="keyword">mov</span>     this, <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">call</span>    sub_4CA77A</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">edi</span>, [this+<span class="number">24h</span>]</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">edi</span></div><div class="line">    <span class="keyword">call</span>    sub_4CBFDB</div><div class="line">    <span class="keyword">or</span>      <span class="built_in">dword</span> <span class="built_in">ptr</span> [this+<span class="number">48h</span>], <span class="number">0FFFFFFFFh</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+<span class="number">4Ch</span>]</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [this], offset const CContentMenuItem::<span class="string">'vftable'</span>&#123;for <span class="string">'CContentMenuItem'</span>&#125;</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>], offset const CContentMenuItem::<span class="string">'vftable'</span>&#123;for <span class="string">'CNativeEventSource'</span>&#125;</div><div class="line">    <span class="keyword">call</span>    sub_4D8000</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+<span class="number">50h</span>]</div><div class="line">    <span class="keyword">call</span>    sub_4D8000</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+<span class="number">54h</span>]</div><div class="line">    <span class="keyword">call</span>    sub_4D8000</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+<span class="number">58h</span>]</div><div class="line">    <span class="keyword">call</span>    sub_4D8000</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+<span class="number">5Ch</span>]</div><div class="line">    <span class="keyword">call</span>    sub_4D8000</div><div class="line">    <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+<span class="number">64h</span>], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+<span class="number">68h</span>], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+<span class="number">6Ch</span>], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">edi</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [this+<span class="number">60h</span>], offset const CEventSinkList::<span class="string">'vftable'</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, this</div><div class="line">    <span class="keyword">pop</span>     this</div><div class="line">    <span class="keyword">retn</span></div><div class="line">sub_52B5E0      endp</div></pre></td></tr></table></figure>
<p>ÁºñËØëÂô®Âú®<strong>È¢ÑË®Ä</strong>(<code>prolog</code>) ‰πãÂêéË¶ÅÂÅöÁöÑÁ¨¨‰∏Ä‰ª∂‰∫ãÂ∞±ÊòØÊää <code>_this_</code> ÊåáÈíàÁöÑÂÄº‰ªé <code>ecx</code> Êã∑Ë¥ùÂà∞ <code>esi</code>ÔºåÁªßËÄåÂêéÁª≠ÊâÄÊúâÁöÑÂØªÂùÄÈÉΩÊòØÁõ∏ÂØπ‰∫é <code>esi</code> ‰Ωú‰∏∫Âü∫ÂùÄ„ÄÇÂú®ÂàùÂßãÂåñ<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>(<code>vfptrs</code>) ‰πãÂâçË∞ÉÁî®‰∫Ü‰∏§‰∏™ÂÖ∂‰ªñÂáΩÊï∞ÔºåËøô‰∏ÄÂÆöÊòØ<strong>Âü∫Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞</strong>‚Äî‚ÄîÊú¨‰æã‰∏≠Âç≥ <code>CDownloader</code> Âíå <code>CNativeEventSource</code> ÁöÑÊûÑÈÄ†ÂáΩÊï∞„ÄÇËøõ‰∏ÄÊ≠•Ê∑±ÂÖ•ÂáΩÊï∞Ë∑üË∏™ÂàÜÊûêÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨Á°ÆËÆ§Ëøô‰∏ÄÁÇπÔºöÁ¨¨‰∏Ä‰∏™<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ôºà <code>vfptf</code> ÔºâÁî® <code>CDownloader::&#39;vftable&#39;</code> Êù•ÂàùÂßãÂåñÔºå Á¨¨‰∫å‰∏™<strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Áî® <code>CNativeEventSource::&#39;vftable&#39;</code> Êù•ÂàùÂßãÂåñ„ÄÇÊàë‰ª¨‰πüÂèØ‰ª•Ëøõ‰∏ÄÊ≠•Ê£ÄÊü• <code>CDownloader</code> ÁöÑ<strong>ÊûÑÈÄ†ÂáΩÊï∞</strong> ‚Äî‚Äî ÂÆÉË∞ÉÁî®‰∫ÜÂÖ∂<strong>Âü∫Á±ª</strong> <code>CNativeEventSink</code> ÁöÑÊûÑÈÄ†ÂáΩÊï∞„ÄÇ</p>
<p>Á±ª‰ººÁöÑÔºå<code>_this_</code> ÊåáÈíàÁöÑÂÄºÈÄöËøá <code>edi</code> ‰º†ÂÖ•ÔºåËøôÊó∂ÂÆÉË¢´ÈáçÁΩÆ‰∏∫ <code>_this_ + 24h</code> ÔºåÊ†πÊçÆÊàë‰ª¨‰∏äÈù¢ÁöÑÁ±ªÁªìÊûÑÂõæÊù•ÁúãÔºåËøôÊòØ <code>CNativeEventSource</code> Â≠êÂØπË±°ÁöÑ‰ΩçÁΩÆ„ÄÇËøôÊòØÂè¶‰∏Ä‰∏™ËØÅÊòéË¢´Ë∞ÉÁî®ÁöÑÁ¨¨‰∫å‰∏™ÂáΩÊï∞ÊòØ <code>CNativeEventSource</code> ÁöÑÊûÑÈÄ†ÂáΩÊï∞ÁöÑËØÅÊçÆ„ÄÇ</p>
<p>ÁªìÊùü‰∫ÜÂü∫Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞Ë∞ÉÁî®ËøáÁ®ã‰πãÂêéÔºå<strong>Âü∫Á±ª</strong>‰∏≠ÁöÑ<strong>ËôöÂáΩÊï∞ÊåáÈíà</strong>Ë¢´ <code>CContentMenuItem</code> ‰∏≠Ëá™Â∑±ÁöÑÂÆûÁé∞ÊâÄË¶ÜÁõñÔºåÂç≥ <code>CContentMenuItem</code> ÂÆûÁé∞‰∫ÜÂü∫Á±ª‰∏≠ÁöÑÈÉ®ÂàÜ<strong>ËôöÂáΩÊï∞</strong>ÔºàÊàñËÄÖÂ¢ûÂä†‰∫ÜËá™Â∑±ÁöÑ<strong>ËôöÂáΩÊï∞</strong>Ôºâ„ÄÇÊúâÂøÖË¶ÅÁöÑËØùÔºåÊàë‰ª¨ÂèØ‰ª•ÂØπÊØîËøô‰∫õË°®„ÄÅÊ£ÄÊü•ÈÇ£‰∫õÊåáÈíàË¢´‰øÆÊîπËøáÊàñË¢´Ê∑ªÂä†‰∫Ü‚Äî‚ÄîÊñ∞Ê∑ªÂä†ÁöÑÊåáÈíàÂ∞±ÊòØ <code>CContentMenuItem</code> ‰∏≠Êñ∞ÂÆûÁé∞ÁöÑËôöÂáΩÊï∞„ÄÇ</p>
<p>Êé•‰∏ãÊù•Êàë‰ª¨Â∞±ÁúãÂà∞Âá†‰∏™ÂØπÂú∞ÂùÄ <code>.04D8000</code> ÁöÑË∞ÉÁî®ÔºåË∞ÉÁî®‰πãÂâç <code>ecx</code> ÁöÑÂÄºË¢´ËÆæÁΩÆ‰∏∫ <code>this+4Ch</code> Âà∞ <code>this+5Ch</code> ‚Äî‚Äî ËøôÂæàÊòéÊòæÊòØÂú®ÂàùÂßãÂåñÊàêÂëòÂØπË±°„ÄÇ‰∏Ä‰∏™ÈóÆÈ¢òÊòØÔºåÊàë‰ª¨Â¶Ç‰ΩïÂàÜËæ®ÂàùÂßãÂåñÂáΩÊï∞ÊòØÁºñËØëÂô®Ëá™Âä®ÁîüÊàêÁöÑÊûÑÈÄ†ÂáΩÊï∞ÔºåËøòÊòØÁ®ãÂ∫èÂëòÁºñÂÜôÁöÑËá™ÂÆö‰πâÊûÑÈÄ†ÂáΩÊï∞Âë¢ÔºüËøôÈáåÊúâ‰∏§‰∏™ÂÖ≥ÈîÆÁÇπÂèØ‰ª•ÂèÇËÄÉÔºö</p>
<ul>
<li>ÂáΩÊï∞‰ΩøÁî® <code>_thiscall_</code> ÁöÑ <strong>Ë∞ÉÁî®Á∫¶ÂÆö</strong>ÔºåËÄå‰∏îÊòØÁ¨¨‰∏ÄÊ¨°ËÆøÈóÆËøô‰∫õÂ≠óÊÆµÔºõ</li>
<li>Â≠óÊÆµÁöÑÂàùÂßãÂåñÈ°∫Â∫èÊòØÊåâÁÖßÂú∞ÂùÄÂ¢ûÈïøÁöÑÊñπÂêëËøõË°åÁöÑ„ÄÇ</li>
</ul>
<p>‰∏∫‰∫ÜÁ°ÆÂÆöËøô‰∫õÁÇπÔºåÊàë‰ª¨ÂèØ‰ª•Êü•Áúã<strong>ÊûêÊûÑÂáΩÊï∞</strong>‰∏≠ÁöÑ<strong>Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞</strong>ÔºàUnwind FuncletsÔºâÔºåÂú®ÈÇ£ÈáåÊàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ÁºñËØëÂô®‰∏∫Ëøô‰∫õÊàêÂëòÂèòÈáèÁîüÊàêÁöÑÊûÑÈÄ†ÂáΩÊï∞„ÄÇ</p>
<p>Ëøô‰∏™Êñ∞ÁöÑÁ±ªÂπ∂Ê≤°Êúâ<strong>ËôöÂáΩÊï∞</strong>ÔºåÂõ†Ê≠§‰πüÊ≤°Êúâ <strong>RTTI</strong>ÔºåÊâÄ‰ª•Êàë‰ª¨‰πü‰∏çÁü•ÈÅìÂÆÉÁöÑÂêçÂ≠óÔºå‰∏çÂ¶®ÂÖàÂëΩÂêç‰∏∫  RefCountedPtr<code>„ÄÇÊ†πÊçÆÂâçÈù¢ÁöÑÂàÜÊûêÔºå‰Ωç‰∫é</code>.4D8000<code>ÁöÑÂáΩÊï∞ÊòØ**ÊûÑÈÄ†ÂáΩÊï∞**ÔºåÈÇ£‰πàÂú®</code>CContentMenuItem<code>Êàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ÊûêÊûÑÂáΩÊï∞‰∏≠ÁöÑ**Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞**‚Äî‚ÄîÂú®</code>.63CCB4` Â§Ñ„ÄÇ</p>
<p>ÂõûËøáÂ§¥ÂéªÁúã <code>CContentMenuItem</code> ÁöÑ <strong>ÊûÑÈÄ†ÂáΩÊï∞</strong>ÔºåÂèØ‰ª•ÁúãÂà∞ 3 ‰∏™Â≠óÊÆµÂàùÂßãÂåñ‰∏∫ 0ÔºåÂè¶Â§ñ‰∏Ä‰∏™ÂàùÂßãÂåñ‰∏∫‰∏Ä‰∏™ <strong>ËôöÂáΩÊï∞Ë°®ÊåáÈíà</strong>Ôºà <code>vftable pointer</code> Ôºâ„ÄÇËøô‰∏™ÁúãËµ∑Êù•ÊÉ≥‰∏Ä‰∏™ÊàêÂëòÂèòÈáèÁöÑÂÜÖËÅîÊûÑÈÄ†ÂáΩÊï∞Ôºà‰∏çÊòØ<strong>Âü∫Á±ª</strong>ÔºåÂõ†‰∏∫<strong>Âü∫Á±ª</strong>‰ºöÂá∫Áé∞Âú®ÁªßÊâøÂÖ≥Á≥ªÊ†ë‰∏≠Ôºâ„ÄÇ‰ªé‰∏Ä‰∏™‰ΩøÁî®‰∫ÜÁöÑËôöÂáΩÊï∞Ë°®ÁöÑ RTTI ‰∏≠Êàë‰ª¨ÂèØ‰ª•ÁúãÂá∫ËøôÊòØ‰∏Ä‰∏™ <code>CEventSinkList</code> Ê®°ÊùøÁöÑÂÆû‰æã„ÄÇ</p>
<p>Ê†πÊçÆ‰∏äÈù¢ÁöÑÂàÜÊûêÔºåÊàë‰ª¨ÂèØ‰ª•Â§ßÊ¶ÇÂãæÂãíÂá∫Á±ªÁöÑÁªìÊûÑÂ£∞ÊòéÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> CContentMenuItem: <span class="keyword">public</span> CDownloader, <span class="keyword">public</span> CNativeEventSource</div><div class="line">&#123;</div><div class="line"><span class="comment">/* 00 CDownloader */</span></div><div class="line"><span class="comment">/* 24 CNativeEventSource */</span></div><div class="line"><span class="comment">/* 48 */</span> DWORD m_unknown48;</div><div class="line"><span class="comment">/* 4C */</span> RefCountedPtr m_ptr4C;</div><div class="line"><span class="comment">/* 50 */</span> RefCountedPtr m_ptr50;</div><div class="line"><span class="comment">/* 54 */</span> RefCountedPtr m_ptr54;</div><div class="line"><span class="comment">/* 58 */</span> RefCountedPtr m_ptr58;</div><div class="line"><span class="comment">/* 5C */</span> RefCountedPtr m_ptr5C;</div><div class="line"><span class="comment">/* 60 */</span> CEventSinkList m_EventSinkList;</div><div class="line"><span class="comment">/* size = 70? */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Êàë‰ª¨‰∏çÁ°ÆÂÆöÂÅèÁßª‰∏∫ <code>0x48</code> Â§ÑÁöÑÂèòÈáèÊòØÂê¶‰∏∫ <code>CNativeEventSource</code> ÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰ΩÜÁî±‰∫éÂÆÉÂπ∂Ê≤°ÊúâË¢´ <code>CNativeEventSource</code> ÁöÑÊûÑÈÄ†ÂáΩÊï∞ËÆøÈóÆÂà∞ÔºåÈÇ£‰πàÂÆÉÂæàÂèØËÉΩÂ±û‰∫é <code>CContentMenuItem</code>„ÄÇÂåÖÂê´Ë¢´ÈáçÂëΩÂêçÂáΩÊï∞ÁöÑÊûÑÈÄ†ÂáΩÊï∞‰∏éÁ±ªÁöÑÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">public:</span> __thiscall CContentMenuItem::CContentMenuItem(void) proc <span class="built_in">near</span></div><div class="line">    <span class="keyword">push</span>    this</div><div class="line">    <span class="keyword">push</span>    <span class="built_in">edi</span></div><div class="line">    <span class="keyword">mov</span>     this, <span class="built_in">ecx</span></div><div class="line">    <span class="keyword">call</span>    CDownloader::CDownloader(void)</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">edi</span>, [this+CContentMenuItem._CNativeEventSource]</div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">edi</span></div><div class="line">    <span class="keyword">call</span>    CNativeEventSource::CNativeEventSource(void)</div><div class="line">    <span class="keyword">or</span>      [this+CContentMenuItem.m_unknown48], -<span class="number">1</span></div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+CContentMenuItem.m_ptr4C]</div><div class="line">    <span class="keyword">mov</span>     [this+CContentMenuItem._CDownloader._vfptr], offset const CContentMenuItem::<span class="string">'vftable'</span>&#123;for <span class="string">'CContentMenuItem'</span>&#125;</div><div class="line">    <span class="keyword">mov</span>     [<span class="built_in">edi</span>+CNativeEventSource._vfptr], offset const CContentMenuItem::<span class="string">'vftable'</span>&#123;for <span class="string">'CNativeEventSource'</span>&#125;</div><div class="line">    <span class="keyword">call</span>    RefCountedPtr::RefCountedPtr(void)</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+CContentMenuItem.m_ptr50]</div><div class="line">    <span class="keyword">call</span>    RefCountedPtr::RefCountedPtr(void)</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+CContentMenuItem.m_ptr54]</div><div class="line">    <span class="keyword">call</span>    RefCountedPtr::RefCountedPtr(void)</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+CContentMenuItem.m_ptr58]</div><div class="line">    <span class="keyword">call</span>    RefCountedPtr::RefCountedPtr(void)</div><div class="line">    <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [this+CContentMenuItem.m_ptr5C]</div><div class="line">    <span class="keyword">call</span>    RefCountedPtr::RefCountedPtr(void)</div><div class="line">    <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+CContentMenuItem.m_EventSinkList.field_4], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+CContentMenuItem.m_EventSinkList.field_8], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">mov</span>     [this+CContentMenuItem.m_EventSinkList.field_C], <span class="built_in">eax</span></div><div class="line">    <span class="keyword">pop</span>     <span class="built_in">edi</span></div><div class="line">    <span class="keyword">mov</span>     [this+CContentMenuItem.m_EventSinkList._vfptr], offset const CEventSinkList::<span class="string">'vftable'</span></div><div class="line">    <span class="keyword">mov</span>     <span class="built_in">eax</span>, this</div><div class="line">    <span class="keyword">pop</span>     this</div><div class="line">    <span class="keyword">retn</span></div><div class="line"><span class="symbol">public:</span> __thiscall CContentMenuItem::CContentMenuItem(void) endp</div></pre></td></tr></table></figure>
<h2 id="ÂèÇËÄÉËµÑÊñôÔºö"><a href="#ÂèÇËÄÉËµÑÊñôÔºö" class="headerlink" title="ÂèÇËÄÉËµÑÊñôÔºö"></a>ÂèÇËÄÉËµÑÊñôÔºö</h2><ol>
<li><a href="http://msdn.microsoft.com/archive/default.asp?url=/archive/en-us/dnarvc/html/jangrayhood.asp" target="_blank" rel="external">http://msdn.microsoft.com/archive/default.asp?url=/archive/en-us/dnarvc/html/jangrayhood.asp</a></li>
<li><a href="http://www.lrdev.com/lr/c/virtual.html" target="_blank" rel="external">http://www.lrdev.com/lr/c/virtual.html</a></li>
<li><p>ÂæÆËΩØÂÖ≥‰∫é C++ ÂêÑÈÉ®ÂàÜÂÆûÁé∞ÁöÑ‰∏ìÂà©ÊùêÊñôÔºö</p>
<ul>
<li><a href="http://freepatentsonline.com/5410705.html" target="_blank" rel="external">http://freepatentsonline.com/5410705.html</a></li>
<li><a href="http://freepatentsonline.com/5617569.html" target="_blank" rel="external">http://freepatentsonline.com/5617569.html</a></li>
<li><a href="http://freepatentsonline.com/5754862.html" target="_blank" rel="external">http://freepatentsonline.com/5754862.html</a></li>
<li><a href="http://freepatentsonline.com/5297284.html" target="_blank" rel="external">http://freepatentsonline.com/5297284.html</a></li>
<li><a href="http://freepatentsonline.com/5371891.html" target="_blank" rel="external">http://freepatentsonline.com/5371891.html</a></li>
<li><a href="http://freepatentsonline.com/5603030.html" target="_blank" rel="external">http://freepatentsonline.com/5603030.html</a></li>
<li><a href="http://freepatentsonline.com/6138269.html" target="_blank" rel="external">http://freepatentsonline.com/6138269.html</a></li>
</ul>
</li>
<li><p><a href="http://members.ozemail.com.au/~geoffch@ozemail.com.au/samples/programming/msvc/language/predefined/index.html" target="_blank" rel="external">http://members.ozemail.com.au/~geoffch@ozemail.com.au/samples/programming/msvc/language/predefined/index.html</a></p>
</li>
<li><a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclang/html/_predir_init_seg.asp" target="_blank" rel="external">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclang/html/_predir_init_seg.asp</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div><font color="green">ÁúãÂæóÁàΩÁöÑËØùÔºåËµûÂä©‰∏™Âú∞ÈìÅÈÄöÂã§Ë¥πÔºü</font></div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>Ëµè</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/imgs/wechat.png" alt="0xjiayu WeChat Pay"/>
          <p>ÂæÆ‰ø°ÊâìËµè</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/imgs/alipay.png" alt="0xjiayu Alipay"/>
          <p>ÊîØ‰ªòÂÆùÊâìËµè</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <div style="MARGIN-TOP: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px">
    <IMG alt="" src="https://avatars3.githubusercontent.com/u/4980416?v=3&s=140" width=120 height=120>
  </div>
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>Post author:</strong>
      <a href="mailto:jiayu0x@gmail.com"> 0xjiayu </a>
    </li>
    <li class="post-copyright-link">
      <strong>Post link:</strong>
      <a href="http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/" title="(ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI">http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright Notice: </strong>
      All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/security/" rel="tag"># security</a>
          
            <a href="/tags/c/" rel="tag"># c++</a>
          
            <a href="/tags/re/" rel="tag"># re</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/25/reversing-msvcxx-exception-handling/" rel="next" title="(ËØë)MSVC++ ÈÄÜÂêë(‰∏Ä) ‚Äî‚Äî ÂºÇÂ∏∏Â§ÑÁêÜ">
                <i class="fa fa-chevron-left"></i> (ËØë)MSVC++ ÈÄÜÂêë(‰∏Ä) ‚Äî‚Äî ÂºÇÂ∏∏Â§ÑÁêÜ
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="0xjiayu" />
          <p class="site-author-name" itemprop="name">0xjiayu</p>
           
              <p class="site-description motion-element" itemprop="description">About Security/Coding‚Ä¶‚Ä¶ and life.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä"><span class="nav-number">1.</span> <span class="nav-text">Á±ªÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÂü∫Á°Ä</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï"><span class="nav-number">2.</span> <span class="nav-text">Ë∞ÉÁî®Á∫¶ÂÆö‰∏éÁ±ªÊñπÊ≥ï</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-ÈùôÊÄÅÊàêÂëòÂáΩÊï∞"><span class="nav-number">2.1.</span> <span class="nav-text">1) ÈùôÊÄÅÊàêÂëòÂáΩÊï∞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ÊôÆÈÄöÊàêÂëòÂáΩÊï∞"><span class="nav-number">2.2.</span> <span class="nav-text">2) ÊôÆÈÄöÊàêÂëòÂáΩÊï∞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ËôöÂáΩÊï∞"><span class="nav-number">2.3.</span> <span class="nav-text">3) ËôöÂáΩÊï∞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞"><span class="nav-number">2.4.</span> <span class="nav-text">4) ÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RTTI-ÁöÑÂÆûÁé∞"><span class="nav-number">3.</span> <span class="nav-text">RTTI ÁöÑÂÆûÁé∞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#‰ø°ÊÅØÊèêÂèñ"><span class="nav-number">4.</span> <span class="nav-text">‰ø°ÊÅØÊèêÂèñ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-RTTI"><span class="nav-number">4.1.</span> <span class="nav-text">1) RTTI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ÈùôÊÄÅÂàùÂßãÂåñ-Âíå-ÂÖ®Â±ÄÂàùÂßãÂåñ"><span class="nav-number">4.2.</span> <span class="nav-text">2) ÈùôÊÄÅÂàùÂßãÂåñ Âíå ÂÖ®Â±ÄÂàùÂßãÂåñ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind-FuncletsÔºâ"><span class="nav-number">4.3.</span> <span class="nav-text">3) Ê†àÂ±ïÂºÄÂ§ÑÁêÜÂáΩÊï∞ÔºàUnwind FuncletsÔºâ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ÈÄíÂΩíÊûÑÈÄ†-ÊûêÊûÑÂáΩÊï∞"><span class="nav-number">4.4.</span> <span class="nav-text">4) ÈÄíÂΩíÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ"><span class="nav-number">4.5.</span> <span class="nav-text">5) Êï∞ÁªÑÊûÑÈÄ†‰∏éÊûêÊûÑ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà-deleting-destructor-Ôºâ"><span class="nav-number">4.6.</span> <span class="nav-text">6) Âà†Èô§ÊûêÊûÑÂáΩÊï∞Ôºà deleting destructor Ôºâ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ÈôÑÂΩï-1Ôºö-ms-rtti4-idc"><span class="nav-number">5.</span> <span class="nav-text">ÈôÑÂΩï 1Ôºö ms_rtti4.idc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ÈôÑÂΩï-2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ"><span class="nav-number">6.</span> <span class="nav-text">ÈôÑÂΩï 2ÔºöÂÆûÊàòÊÅ¢Â§ç‰∏Ä‰∏™Á±ªÁöÑÁªìÊûÑ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ÂèÇËÄÉËµÑÊñôÔºö"><span class="nav-number">7.</span> <span class="nav-text">ÂèÇËÄÉËµÑÊñôÔºö</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>

    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xjiayu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jiayu0x.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://jiayu0x.com/2017/04/30/reversing-msvcxx-exception-handling-2/';
          this.page.identifier = '2017/04/30/reversing-msvcxx-exception-handling-2/';
          this.page.title = '(ËØë)MSVC++ ÈÄÜÂêëÔºà‰∫åÔºâ‚Äî‚Äî Á±ª„ÄÅÊñπÊ≥ïÂíå RTTI';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://jiayu0x.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  


</body>
</html>
